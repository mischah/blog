<!DOCTYPE html>
<html lang="en">

<head>


<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Matthias Altmann">
<meta name="description" content="Port Forwarding explained using Docker / Pivoting 101">

<title>Port Forwarding explained using Docker</title>

<!-- Bootstrap core CSS -->
<link href="/blog/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap core JavaScript -->
<script src="/blog/vendor/jquery/jquery.min.js"></script>
<script src="/blog/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Custom fonts for this template -->
<link href="/blog/vendor/fontawesome-free-web/css/all.css" rel="stylesheet" type="text/css">
<link href='/blog/vendor/fonts-googleapis/lora.css' rel='stylesheet' type='text/css'>
<link href='/blog/vendor/fonts-googleapis/opensans.css' rel='stylesheet' type='text/css'>

<link rel="shortcut icon" href="/blog/assets/img/favicon.ico" type="image/x-icon">
<link rel="icon" href="/blog/assets/img/favicon.ico" type="image/x-icon">

<script src="/blog/vendor/jquery/jquery.min.js"></script>
<script src="/blog/vendor/gsap/gsap.min.js"></script>

<script src="/blog/vendor/highlight/highlight.pack.js"></script>
<link href="/blog/vendor/highlight/styles/default.css" rel="stylesheet" type="text/css">
<script>hljs.initHighlightingOnLoad();</script>

<link href="/blog/vendor/malihu-jquery-custom-scrollbar/jquery.mCustomScrollbar.min.css" rel="stylesheet">
<script src="/blog/vendor/malihu-jquery-custom-scrollbar/jquery.mCustomScrollbar.js"></script>

<!-- Custom styles and scripts -->
<link href="/blog/css/clean-blog.min.css" rel="stylesheet">
<script src="/blog/js/clean-blog.min.js"></script>

<link href="/blog/css/svganimations.css" rel="stylesheet">

<script src="/blog/js/sidebar.js"></script>
<link href="/blog/css/sidebar.css" rel="stylesheet">

<!-- For atom rss feed that browser can detect rss on side -->
<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Sitewide Atom feed" />
<script src="/blog/vendor/mermaid/mermaid-8.14.0.min.js"></script>





</head>

<body>

<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container px-4 px-lg-5">
        <a class="navbar-brand" id="nav-link-main" href="/blog/index.html">~/sec/f00tprint</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
            Menu
            <i class="fa fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ms-auto py-4 py-lg-0">
                <li class="nav-item">
                    <a class="nav-link px-lg-3 py-3 py-lg-4" href="/blog/index.html">Posts</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link px-lg-3 py-3 py-lg-4" href="/blog/germancorner.html">German Corner</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link px-lg-3 py-3 py-lg-4" href="/blog/portforwarding-docker/en">Last Post</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link px-lg-3 py-3 py-lg-4" href="/blog/about.html">About</a>
                </li>
            </ul>
        </div>
    </div>
</nav>


<!-- Page Header -->
<header class="masthead" style="background-image:url('/blog/assets/img/post_backgrounds/home-matrix.png')">
    <div class="overlay"></div>
    <div class="container position-relative px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">
                <div class="site-heading">
                    <h1>Port Forwarding explained using Docker</h1>
                    
                    <h2 class="subheading">Pivoting 101</h2>
                    
                    
                    <span class="meta">Posted on March 28, 2022</span>
                    

                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">

        
        <nav id="sidebar" class="sidebar-wrapper active">
            <div class="sidebar-header">
                <h3>Table of contents</h3>
                <h4>Port Forwarding explained using Docker</h4>
            </div>

            <ul class="list-unstyled components">
                <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#introduction">Introduction</a></li>
<li class="toc-entry toc-h1"><a href="#get-a-server-from-someone-else">Get a server from someone else</a></li>
<li class="toc-entry toc-h1"><a href="#port-forwarding-und-tunneling">Port Forwarding und Tunneling</a></li>
<li class="toc-entry toc-h1">
<a href="#local-port-forwarding">Local Port Forwarding</a>
<ul>
<li class="toc-entry toc-h2"><a href="#local-port-forwarding-using-rinetd">Local Port Forwarding using rinetd</a></li>
<li class="toc-entry toc-h2"><a href="#local-port-forwarding-using-socat">Local Port Forwarding using socat</a></li>
<li class="toc-entry toc-h2"><a href="#local-portforwarding-using-netcat">Local Portforwarding using netcat</a></li>
<li class="toc-entry toc-h2"><a href="#local-portforwarding-using-perl">Local Portforwarding using Perl</a></li>
<li class="toc-entry toc-h2">
<a href="#local-portforwarding-using-python">Local Portforwarding using Python</a>
<ul>
<li class="toc-entry toc-h3"><a href="#local-port-forwarding-using-netsh">Local Port Forwarding using netsh</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#local-port-forwarding-without-tunnel">Local Port Forwarding without tunnel</a></li>
<li class="toc-entry toc-h2"><a href="#local-port-forwarding-using-ssh">Local Port Forwarding using ssh</a></li>
<li class="toc-entry toc-h2"><a href="#local-port-forwarding-using-plink">Local Port Forwarding using plink</a></li>
<li class="toc-entry toc-h2"><a href="#local-port-forwarding-using-ssf">Local Port Forwarding using ssf</a></li>
<li class="toc-entry toc-h2"><a href="#remote-port-forwarding">Remote Port Forwarding</a></li>
<li class="toc-entry toc-h2"><a href="#dynamic-port-forwarding">Dynamic Port Forwarding</a></li>
<li class="toc-entry toc-h2"><a href="#examples-and-tools">Examples and Tools</a></li>
</ul>
</li>
<li class="toc-entry toc-h1">
<a href="#hi-from-inside-server">Hi from inside server</a>
<ul>
<li class="toc-entry toc-h3"><a href="#plink">plink</a></li>
<li class="toc-entry toc-h3"><a href="#sshuttle">sshuttle</a></li>
<li class="toc-entry toc-h3"><a href="#socat">socat</a></li>
<li class="toc-entry toc-h3"><a href="#ssf">ssf</a></li>
</ul>
</li>
<li class="toc-entry toc-h1">
<a href="#kubernetes">Kubernetes</a>
<ul>
<li class="toc-entry toc-h2">
<a href="#faq">FAQ</a>
<ul>
<li class="toc-entry toc-h3"><a href="#docker-without-sudo">Docker without sudo</a></li>
<li class="toc-entry toc-h3"><a href="#pool-overlaps">Pool overlaps</a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </ul>

        </nav>
        

        <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                
                <button type="button" id="sidebarCollapse" class="btn btn-primary-sm btn btn-block">
                    <i class="fas fa-align-left"></i>
                    <span>Toggle Table of Contents</span>
                </button>
                
                <br>
                <p>x Kubernetes Port Forwarding</p>

<h1 id="introduction">
<a class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h1>

<p>Do you know this situation? There is a great web server on your network and you want to show it to someone but don’t know how?</p>

<p>Port forwarding can be used to make remote systems accessible that would otherwise be inaccessible.
This tutorial is about how to get access to a service or server that is located on another machine, even if it is on a different network.
In contrast to other introductions, it is based upon Docker thus you can pull it out later to see how the individual steps work on a real example if needed.
In the past, I often had problems understanding the subject in its entirety. This had to do with various points:</p>
<ul>
  <li>First, that I didn’t really understand where something happens and how.</li>
  <li>And then, on this poor basis, what which command did and what I can then use it for.
That’s why I tried to make this tutorial as simple as possible on the one hand and to provide it with numerous examples on the other hand.</li>
</ul>

<p>The used examples are based on the great blog posts
<a href="https://erev0s.com/blog/ssh-local-remote-and-dynamic-port-forwarding-explain-it-i-am-five/" target="_blank" rel="noopener noreferrer">SH Local, Remote and Dynamic Port Forwarding - Explain it like I am five!</a> and
<a href="https://catonmat.net/perl-tcp-proxy" target="_blank" rel="noopener noreferrer">https://catonmat.net/perl-tcp-proxy</a>.</p>

<p>The following infrastructure serves as a basis:</p>

<div id="html" class="mermaid">graph TD
A(<b>outside</b><br> IP: 192.168.1.3<br>lives in 192.168.1.x) --- B(jumphost)
subgraph 192.168.2.x
B(<b>jumphost</b><br> IPs: 192.168.1.5, 192.168.2.5<br>lives in 192.168.1.x and<br>192.168.2.x ) --- C(<b>inside_server</b> 192.168.2.50 <br>lives in 192.168.2.x)
end
</div>

<p>That is, you have two networks that intersect at one computer, the jump host. The inner network can therefore only be accessed from the outside via the jump host.
The server in the inner network, called “inside_server”, has an HTTP server running.</p>

<p>To start this infrastructure do (you need <a href="https://docs.docker.com/get-docker/" target="_blank" rel="noopener noreferrer">docker</a> installed)</p>

<pre><code class="bash">git clone https://github.com/secf00tprint/portforwarding_test.git
cd portforwarding_test
sudo docker-compose up --build --force-recreate
</code></pre>

<p>If you have any problems running it you can find an (<a href="#faq">FAQ</a>) at the end of this article.</p>

<p>The following aliases are used, which you can set with:</p>

<pre><code class="bash">alias dops='sudo docker ps -a'
alias doeti='sudo docker exec -ti '
</code></pre>

<p>Use</p>

<pre><code class="bash">dops
</code></pre>

<p>to display the Docker container IDs.</p>

<p>And enter</p>

<pre><code class="bash">doeti &lt;id&gt; bash
</code></pre>

<p>to log into a specific container.</p>

<p>For the rest of this post 3 Ids are important:</p>

<p><img src="/blog/assets/img/pivoting/portforwarding//docker_dops_output.png" width="100%" alt="Docker ps output"></p>

<p>Which we will refer to as &lt;id_outside&gt;,&lt;id_jumphost&gt; and &lt;id_inside_server&gt;</p>

<h1 id="get-a-server-from-someone-else">
<a class="anchor" href="#get-a-server-from-someone-else" aria-hidden="true"><span class="octicon octicon-link"></span></a>Get a server from someone else</h1>

<p>We start with the most simple example:</p>

<p>Someone in the same network wants to show you something. He has an HTTP application running and wants you to inspect it on your computer.</p>

<p>For this we assume you are the computer “jumphost” and the other person is the computer “inside_server”. Firewalls between you are switched off and port 80 is accessible from your computer.</p>

<p>To imitate this, log into inside_server</p>

<pre><code class="bash">doeti &lt;id_inside_server&gt; bash
</code></pre>

<p>Check if you have started apache:</p>

<pre><code class="bash">netstat -atlnp | grep 80
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      12/httpd
</code></pre>

<p><img src="/blog/assets/img/pivoting/portforwarding//server_running.png" width="100%" alt="Server running"></p>

<p>Then in another console window log into jump host:</p>

<pre><code class="bash">doeti &lt;id_jumphost&gt; bash
</code></pre>

<div>
  <blockquote>
  From the illustration above you can see the IP of the server "inside_server". You can also retrieve it directly on the system with the <code class="bash">ip a</code> command.<br>
  On "inside_server" you can then use the <code class="bash">curl</code> command to access the HTTP application:<br>
  <code class="bash">curl http://&lt;ip from inside_server&gt;:80</code>.
  <br><br>
  What is the text that the HTTP application returns?
  </blockquote>
  
  <p>
    <button class="btn btn-outline-primary btn-lg btn-block" type="button" data-bs-toggle="collapse" data-bs-target="#exercise_portforwarding_1" aria-expanded="false" aria-controls="exercise_portforwarding_1">
      See Answer
    </button>
  </p>
  <div class="collapse" id="exercise_portforwarding_1">
  <div class="card card-body">
  <p class="card-text">From the picture above you can get the IP of "inside_server": <code>192.168.2.50</code>. To call the http application you can leverage the command <code class="bash">curl</code> :
  <br><br>
  
  <code class="bash">
  curl http://192.168.2.50:80
  <br>
  Hi from inside server
  </code>
  <br><br>
  So the solution is <br><code class="bash">Hi from inside server</code>
  </p>
  </div>
  </div>

</div>

<p>Or if you have <a href="https://linux.die.net/man/1/socat" target="_blank" rel="noopener noreferrer">socat</a> available (which is installed at the jump host):</p>

<pre><code class="bash">printf "GET / HTTP/1.0\r\n\r\n" | socat - TCP4:192.168.2.50:80
HTTP/1.1 200 OK

Server: Apache/2.4.53 (Unix)
... 
Content-Type: text/html

&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi from inside server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>

<p>You successfully reached the application which someone wanted to share with you.</p>

<h1 id="port-forwarding-und-tunneling">
<a class="anchor" href="#port-forwarding-und-tunneling" aria-hidden="true"><span class="octicon octicon-link"></span></a>Port Forwarding und Tunneling</h1>

<p>To get deeper into the matter you need some background knowledge:</p>

<p>In addition to an IP, which is used as an address in the network, a network-connected device has a port number.</p>

<p>This port number is used to address the correct background service on the device.</p>

<p>As an example from our infrastructure. The address 192.168.2.50 shows the address of the server “internal”. The web server runs on port 80 on this server, so that the web server can be reached unambiguously via the combination IP:port 192.168.2.50:80.</p>

<p>Now to the concept of port forwarding:</p>

<p>It is now possible to fetch this IP:port combination from a reachable remote computer.
Or the other way around to send your own service to someone else.
Both will be explained in more detail in the following sections. The generic term here is port forwarding.</p>

<p>Port forwarding is initially only possible in your own network. Exception: You put a line into another network. This is also called “tunneling”. More on this topic later.</p>

<h1 id="local-port-forwarding">
<a class="anchor" href="#local-port-forwarding" aria-hidden="true"><span class="octicon octicon-link"></span></a>Local Port Forwarding</h1>

<p>For the next scenario, you use a technique call <em>Local Port Forwarding</em>. 
With this technique you <em>bring a remote server to you</em>.</p>

<p>We’ll first look at what this means inside a network and how to use it to get a service out of a network.
In this case, let’s imagine you have access to a server. This server has 2 network interfaces. One which is accessible from the Internet and one with a private IP address. An employee comes to you and tells you he would like to have his website, which is running on his server, on the internet. However, his computer is only in the private network and cannot be accessed from the Internet.</p>

<p>Now, to get its server from the private network to you on the public IP address there are several techniques among others:</p>

<ul>
  <li><a href="http://manpages.ubuntu.com/manpages/bionic/man8/rinetd.8.html" target="_blank" rel="noopener noreferrer">rinetd</a></li>
  <li>
<a href="https://linux.die.net/man/1/socat" target="_blank" rel="noopener noreferrer">socat</a> or <a href="https://en.wikipedia.org/wiki/Netcat" target="_blank" rel="noopener noreferrer">Netcat</a> in the linux domain</li>
  <li>
<a href="https://docs.microsoft.com/en-us/windows-server/networking/technologies/netsh/netsh-contexts" target="_blank" rel="noopener noreferrer">netsh</a> in Windows</li>
  <li>Usage of programming languages like <a href="https://www.perl.org/" target="_blank" rel="noopener noreferrer">Perl</a> or <a href="https://www.python.org/" target="_blank" rel="noopener noreferrer">Python</a>
</li>
</ul>

<h2 id="local-port-forwarding-using-rinetd">
<a class="anchor" href="#local-port-forwarding-using-rinetd" aria-hidden="true"><span class="octicon octicon-link"></span></a>Local Port Forwarding using rinetd</h2>

<p>To use rinetd you must have root privileges.</p>

<p>First install it if not already present. We have already done this in our Docker examples:</p>

<pre><code class="bash">sudo apt update &amp;&amp; sudo apt install -y rinetd
</code></pre>

<p>If we now go to the jump host we can get the internal server there:</p>

<pre><code class="bash">doeti &lt;id_jumphost&gt; bash
</code></pre>

<pre><code class="bash">vim /etc/rinetd.conf
</code></pre>

<p>Add the following line</p>

<p>(For those who have not yet worked with vim:
Use the arrow keys to move down, type A for append,
enter the addressed line, Esc and :wq! to save and exit)</p>

<pre><code class="bash">192.168.1.5 8083 192.168.2.50 80
</code></pre>

<p>This causes rinetd to take the server from 192.168.2.50:80 from the inside network (which is 192.168.2.x) and put it on the IP 192.168.1.5:8083, which is the externally reachable IP of the Jump Host you are on.
So everybody outside - the “internet” - represented by the 192.168.1.x network can access now the internal server.</p>

<p>To activate the configuration restart rinetd</p>

<pre><code class="bash">service rinetd restart
</code></pre>

<p>Via netstat you can check if the service from the server is now with you</p>

<pre><code class="bash">netstat -atlnp | grep 8083
tcp        0      0 192.168.1.5:8083        0.0.0.0:*               LISTEN      79/rinetd 
</code></pre>

<p>Imagine that the computer “outside” is a laptop on the Internet. You could now access the internal server using the jump host IP.</p>

<p>Open another console representing the client</p>

<pre><code class="bash">doeti &lt;id_outside&gt; bash
</code></pre>

<pre><code class="bash">curl http://192.168.1.5:8083
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi from inside server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>

<h2 id="local-port-forwarding-using-socat">
<a class="anchor" href="#local-port-forwarding-using-socat" aria-hidden="true"><span class="octicon octicon-link"></span></a>Local Port Forwarding using socat</h2>

<p>The same can be done using the socat tool.</p>

<p>Installable with</p>

<pre><code class="bash">sudo apt update &amp;&amp; sudo apt install -y socat
</code></pre>

<p>Again, we have already done this in the Docker examples.</p>

<p>The procedure is similar</p>

<pre><code class="bash">
doeti &lt;id_jumphost&gt;
socat TCP-LISTEN:8080,fork,reuseaddr TCP:192.168.2.50
</code></pre>

<p>(for a deeper understanding, cf <a href="https://unix.stackexchange.com/a/187038" target="_blank" rel="noopener noreferrer">htt ps://unix.stackexchange.com/a/187038</a>)</p>

<pre><code class="bash">doeti &lt;id_jumphost&gt; 
curl http://127.0.0.1:8080
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi from inside server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
curl http://192.168.2.5:8080
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi from inside server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
curl http://192.168.1.5:8080
</code></pre>

<pre><code class="bash">doeti &lt;id_outside&gt;
curl http://192.168.1.5:8080
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi from inside server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>

<h2 id="local-portforwarding-using-netcat">
<a class="anchor" href="#local-portforwarding-using-netcat" aria-hidden="true"><span class="octicon octicon-link"></span></a>Local Portforwarding using netcat</h2>

<p>You can also use netcat</p>

<pre><code class="bash">sudo apt-get install -y netcat
mkfifo backpipe
while true; do nc -l 8080 0&lt;backpipe | nc 192.168.2.50 80 1&gt;backpipe; done
</code></pre>

<p>Or if you are on a Debian system</p>

<pre><code class="bash">sudo apt-get install -y netcat-traditional
while true; do nc.traditional -l -p 8080 -c "nc 192.168.2.50 80"; done
</code></pre>

<p>If you have problems exiting it with Ctrl-C, enter Ctrl-Z, search the pid with</p>

<pre><code class="bash">ps aux
</code></pre>

<p>and kill the process with</p>

<pre><code class="bash">kill -9 &lt;pid&gt;
</code></pre>

<h2 id="local-portforwarding-using-perl">
<a class="anchor" href="#local-portforwarding-using-perl" aria-hidden="true"><span class="octicon octicon-link"></span></a>Local Portforwarding using Perl</h2>

<p>Sometimes, however, it is the case that you cannot install any software. This can be the case if you have hacked a server, for example, but cannot extend the privileges.</p>

<p>What you can then use is Perl, which is mostly preinstalled on linux systems.</p>

<p>The following code uses the modules IO:Socket and IO:Select, which are often already there.</p>

<p>su jumphost
jumphost</p>

<pre><code class="perl">cat tcp-proxy2.pl

use warnings;
use strict;

use IO::Socket::INET;
use IO::Select;

my @allowed_ips = ('all', '10.10.10.5');
my $ioset = IO::Select-&gt;new;
my %socket_map;

my $debug = 1;

sub new_conn {
    my ($host, $port) = @_;
    return IO::Socket::INET-&gt;new(
        PeerAddr =&gt; $host,
        PeerPort =&gt; $port
    ) || die "Unable to connect to $host:$port: $!";
}

sub new_server {
    my ($host, $port) = @_;
    my $server = IO::Socket::INET-&gt;new(
        LocalAddr =&gt; $host,
        LocalPort =&gt; $port,
        ReuseAddr =&gt; 1,
        Listen    =&gt; 100
    ) || die "Unable to listen on $host:$port: $!";
}

sub new_connection {
    my $server = shift;
    my $remote_host = shift;
    my $remote_port = shift;

    my $client = $server-&gt;accept;
    my $client_ip = client_ip($client);

    unless (client_allowed($client)) {
        print "Connection from $client_ip denied.\n" if $debug;
        $client-&gt;close;
        return;
    }
    print "Connection from $client_ip accepted.\n" if $debug;

    my $remote = new_conn($remote_host, $remote_port);
    $ioset-&gt;add($client);
    $ioset-&gt;add($remote);

    $socket_map{$client} = $remote;
    $socket_map{$remote} = $client;
}

sub close_connection {
    my $client = shift;
    my $client_ip = client_ip($client);
    my $remote = $socket_map{$client};

    $ioset-&gt;remove($client);
    $ioset-&gt;remove($remote);

    delete $socket_map{$client};
    delete $socket_map{$remote};

    $client-&gt;close;
    $remote-&gt;close;

    print "Connection from $client_ip closed.\n" if $debug;
}

sub client_ip {
    my $client = shift;
    return inet_ntoa($client-&gt;sockaddr);
}

sub client_allowed {
    my $client = shift;
    my $client_ip = client_ip($client);
    return grep { $_ eq $client_ip || $_ eq 'all' } @allowed_ips;
}

die "Usage: $0 &lt;local port&gt; &lt;remote_host:remote_port&gt;" unless @ARGV == 2;

my $local_port = shift;
my ($remote_host, $remote_port) = split ':', shift();

print "Starting a server on 0.0.0.0:$local_port\n";
my $server = new_server('0.0.0.0', $local_port);
$ioset-&gt;add($server);

while (1) {
    for my $socket ($ioset-&gt;can_read) {
        if ($socket == $server) {
            new_connection($server, $remote_host, $remote_port);
        }
        else {
            next unless exists $socket_map{$socket};
            my $remote = $socket_map{$socket};
            my $buffer;
            my $read = $socket-&gt;sysread($buffer, 4096);
            if ($read) {
                $remote-&gt;syswrite($buffer);
            }
            else {
                close_connection($socket);
            }
        }
    }
}
</code></pre>

<p>Go the jump host. The file is already stored there - normally copy it there.</p>

<pre><code class="bash">doeti &lt;id_jumphost&gt;
perl tcp-proxy2.pl 8080 192.168.2.50:80
Starting a server on 0.0.0.0:8080
</code></pre>

<pre><code class="bash">doeti &lt;id_outside&gt;
curl http://192.168.1.5:8080
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi from inside server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>

<div>

  <blockquote>
   You are sitting at the airport and only HTTP is allowed, so port 80 and 443 is possible to the outside world. But you want to access your SSH server which is listening on port 20. What do you do?
   Your client is &lt;id_inside_client&gt;.  Try to reach the ssh server at 192.168.2.50 credentials: user: inside, password: inside.
  </blockquote>

  <p>
    <button class="btn btn-outline-primary btn-lg btn-block" type="button" data-bs-toggle="collapse" data-bs-target="#exercise_portforwarding_2" aria-expanded="false" aria-controls="exercise_portforwarding_2">
      See Answer
    </button>
  </p>
  <div class="collapse" id="exercise_portforwarding_2">
  <div class="card card-body">
  <p class="card-text">

  </p>
<pre><code class="bash">
doeti &lt;id_jumphost&gt;
perl tcp-proxy2.pl 80 192.168.2.50:22
Starting a server on 0.0.0.0:80
</code></pre>

  <pre><code class="bash">doeti &lt;id_inside_client&gt;
ssh inside@192.168.2.50
  </code></pre>

  Enter "yes","inside" and inside and connect to the ssh server. 

  More information here: <a href="https://catonmat.net/perl-tcp-proxy" target="_blank" rel="noopener noreferrer">https://catonmat.net/perl-tcp-proxy</a>.
  
  </div>
  </div>

</div>

<h2 id="local-portforwarding-using-python">
<a class="anchor" href="#local-portforwarding-using-python" aria-hidden="true"><span class="octicon octicon-link"></span></a>Local Portforwarding using Python</h2>

<p>Often also Python is installed and can be used without admin privileges:</p>

<p>su jumphost
jumphost</p>

<p>https://github.com/vinodpandey/python-port-forward</p>

<p>port-forward.py</p>

<pre><code class="python"># Author: Mario Scondo (www.Linux-Support.com)
# Date: 2010-01-08
# Script template by Stephen Chappell
#
# This script forwards a number of configured local ports
# to local or remote socket servers.
#
# Configuration:
# Add to the config file port-forward.config lines with
# contents as follows:
#   &lt;local incoming port&gt; &lt;dest hostname&gt; &lt;dest port&gt;
#
# Start the application at command line with 'python port-forward.py'
# and stop the application by keying in &lt;ctrl-c&gt;.
#
# Error messages are stored in file 'error.log'.
#

import socket
import sys
import thread
import time

def main(setup, error, args):
    # open file for error messages
    sys.stderr = file(error, 'a')

    # if args
    if (len(args) &gt; 0):
        for settings in parse_args(args):
            thread.start_new_thread(server, settings)
    else:
        # read settings for port forwarding
        for settings in parse(setup):
            thread.start_new_thread(server, settings)
    # wait for &lt;ctrl-c&gt;
    while True:
       time.sleep(60)

def parse(setup):
    settings = list()
    for line in file(setup):
        # skip comment line
        if line.startswith('#'):
            continue

        parts = line.split()
        settings.append((int(parts[0]), parts[1], int(parts[2])))
    return settings

def parse_args(args):
    settings = list()
    for line in args:
        parts = line.split(":")
        settings.append((int(parts[0]), parts[1], int(parts[2])))
    return settings

def server(*settings):
    try:
        dock_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        dock_socket.bind(('', settings[0]))
        dock_socket.listen(5)
        while True:
            client_socket = dock_socket.accept()[0]
            server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            server_socket.connect((settings[1], settings[2]))
            thread.start_new_thread(forward, (client_socket, server_socket))
            thread.start_new_thread(forward, (server_socket, client_socket))
    finally:
        thread.start_new_thread(server, settings)

def forward(source, destination):
    string = ' '
    while string:
        string = source.recv(1024)
        if string:
            destination.sendall(string)
        else:
            source.shutdown(socket.SHUT_RD)
            destination.shutdown(socket.SHUT_WR)

if __name__ == '__main__':
    main('port-forward.config', 'error.log', sys.argv[1:])
</code></pre>

<pre><code class="bash">python port-forward.py 192.168.1.5:192.168.2.50:80
</code></pre>

<p>You can also use config file instead of command arguments:</p>

<pre><code class="bash">port-forward.config

80 localhost 8080
</code></pre>

<p>and then just do</p>

<pre><code class="bash">python port-forward.py
</code></pre>

<h3 id="local-port-forwarding-using-netsh">
<a class="anchor" href="#local-port-forwarding-using-netsh" aria-hidden="true"><span class="octicon octicon-link"></span></a>Local Port Forwarding using netsh</h3>

<p>For Windows there is also a possibility using the net shell:</p>

<pre><code class="cmd">netsh portproxy add v4tov4 listenport=8080 listenaddress=192.168.1.5 connectport=80 connectaddress=192.168.2.50 
</code></pre>

<p>In a Windows Shell at jump host.</p>

<p>Further information</p>

<p><a href="https://smallbusiness.chron.com/forward-port-cmd-52486.html" target="_blank" rel="noopener noreferrer">https://smallbusiness.chron.com/forward-port-cmd-52486.html</a>
<a href="https://www.youtube.com/watch?v=ACjlvzw4bVE" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=ACjlvzw4bVE</a></p>

<h2 id="local-port-forwarding-without-tunnel">
<a class="anchor" href="#local-port-forwarding-without-tunnel" aria-hidden="true"><span class="octicon octicon-link"></span></a>Local Port Forwarding without tunnel</h2>

<p>Everything shown so far is not end-to-end encrypted.
This means that depending on which protocol you send over the line, an attacker can sniff by interposing himself/herself.</p>

<p>Furthermore, you must be on the same network to provide access for a server.</p>

<p>The solution for this are the following tools, which are both end-to-end encrypted and put a line into a network (“tunnel”) over which you can then do the port forwarding as if you were in this network and in this way access servers that are not in your network.</p>

<p>For this purpose there are special programs</p>

<ul>
  <li>
<a href="https://www.openssh.com/manual.html" target="_blank" rel="noopener noreferrer">SSH</a> (Linux)</li>
  <li>
<a href="https://www.chiark.greenend.org.uk/~sgtatham/putty/docs.html" target="_blank" rel="noopener noreferrer">Putty</a> (Windows) or</li>
  <li>
<a href="https://securesocketfunneling.github.io/ssf/#home" target="_blank" rel="noopener noreferrer">Secure Socket Funneling</a> (Linux and Windows)</li>
</ul>

<h2 id="local-port-forwarding-using-ssh">
<a class="anchor" href="#local-port-forwarding-using-ssh" aria-hidden="true"><span class="octicon octicon-link"></span></a>Local Port Forwarding using ssh</h2>

<p>To open a tunnel go in the outside client</p>

<pre><code class="bash">doeti &lt;id_outside&gt; bash
</code></pre>

<p>Bring the internal server from the inside network to you with:</p>

<pre><code class="bash">ssh -L 4444:&lt;ip+port_you_want_to_get_from_the_destination_network&gt; user@&lt;ip_ssh_destination_network_you_have&gt;
</code></pre>

<p>This is similar to the things we’ve done so far.</p>

<pre><code class="bash">ssh -L 4444:&lt;192.168.100.1000:8888&gt; user@&lt;ip_ssh_destination_network_you_have&gt;
</code></pre>

<p>This example would bring the server at 192.168.100.100 Port 8888 from the network you connected with ssh to your interface at Port 4444.</p>

<p>Fire up another console window</p>

<pre><code class="bash">doeti &lt;id_outside&gt; bash
</code></pre>

<p>If everything went well you will see the server you want to reach at your computer</p>

<pre><code class="bash">netstat -atln | grep LISTEN
tcp        0      0 127.0.0.1:4444          0.0.0.0:*               LISTEN

curl http://127.0.0.1:4444
Hi from inside server
</code></pre>

<div>
  <blockquote>
  The task now is to get the internal server to you outside.<br>
  <br>
  IP+port of the internal server: <code>192.168.2.50:80</code><br>
  User and IP of the SSH access to the same network you have: <code>jumphost@192.168.1.5</code>
  </blockquote>

  <p>
    <button class="btn btn-outline-primary btn-lg btn-block" type="button" data-bs-toggle="collapse" data-bs-target="#exercise_portforwarding_1" aria-expanded="false" aria-controls="exercise_portforwarding_1">
      See Answer
    </button>
  </p>
  <div class="collapse" id="exercise_portforwarding_1">
  <div class="card card-body">
  <p class="card-text">In outside <code class="bash">doeti &lt;id_outside&gt; bash</code> do:<br>
  <code class="bash">ssh -L 4444:192.168.2.50:80 jumphost@192.168.1.5</code><br>
  <br>
  Open another console window:<br>
  <code class="bash">doeti &lt;id_outside&gt; bash</code><br>
  Find the port forwarded server at your computer:<br>
  <code class="bash">netstat -atln | grep LISTEN<br>
tcp        0      0 127.0.0.1:4444          0.0.0.0:*               LISTEN<br>
<br>
curl http://127.0.0.1:4444<br>
Hi from inside server
</code>
  </p>
  </div>
  </div>

</div>

<h2 id="local-port-forwarding-using-plink">
<a class="anchor" href="#local-port-forwarding-using-plink" aria-hidden="true"><span class="octicon octicon-link"></span></a>Local Port Forwarding using plink</h2>

<pre><code class="bash">doeti id_outside bash 
wine plink -l "jumphost" -pw "jumphost" -L 4444:192.168.2.50:80 192.168.1.5
</code></pre>

<pre><code class="bash">doeti &lt;id_outside&gt;
curl 127.0.0.1:4444
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi from inside server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>

<h2 id="local-port-forwarding-using-ssf">
<a class="anchor" href="#local-port-forwarding-using-ssf" aria-hidden="true"><span class="octicon octicon-link"></span></a>Local Port Forwarding using ssf</h2>

<pre><code class="bash">doeti id_jumphost
cd ssf-linux-x86_64-3.0.0
./ssfd -p 80
</code></pre>

<pre><code class="bash">doeti id_outside
cd ssf-linux-x86_64-3.0.0
./ssf -L 4444:192.168.2.50:80 -p 80 192.168.1.5
</code></pre>

<pre><code class="bash">doeti &lt;id_outside&gt;
curl http://127.0.0.1:4444
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi from inside server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>

<h2 id="remote-port-forwarding">
<a class="anchor" href="#remote-port-forwarding" aria-hidden="true"><span class="octicon octicon-link"></span></a>Remote Port Forwarding</h2>

<p>One console window</p>

<pre><code class="bash">doeti &lt;id_jumphost&gt; bash
ssh -R 8888:192.168.2.50:80 outside@192.168.1.3
</code></pre>

<pre><code class="bash">doeti &lt;id_outside&gt; bash 

netstat -antlp | grep 8888
tcp        0      0 127.0.0.1:8888          0.0.0.0:*               LISTEN      -

curl 127.0.0.1:8888
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi from inside server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>

<h2 id="dynamic-port-forwarding">
<a class="anchor" href="#dynamic-port-forwarding" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dynamic Port Forwarding</h2>

<pre><code class="bash">doeti &lt;id_outside&gt; 

ssh -D 4444 jumphost@192.168.1.5
</code></pre>

<p>Next console window</p>

<pre><code class="bash">doeti &lt;id_outside&gt;

curl 192.168.2.50 -x socks5://127.0.0.1:5555
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi from inside server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>

<pre><code class="bash">
tail /etc/proxychains.conf
#
#       proxy types: http, socks4, socks5
#        ( auth types supported: "basic"-http  "user/pass"-socks )
#
[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
socks5 	127.0.0.1 5555
</code></pre>

<pre><code class="bash">proxychains nmap 192.168.2.50 -Pn -p 80,22,21 -sT
ProxyChains-3.1 (http://proxychains.sf.net)
Starting Nmap 7.80 ( https://nmap.org ) at 2022-03-23 21:44 UTC
|S-chain|-&lt;&gt;-127.0.0.1:5555-&lt;&gt;&lt;&gt;-192.168.2.50:22-&lt;&gt;&lt;&gt;-OK
|S-chain|-&lt;&gt;-127.0.0.1:5555-&lt;&gt;&lt;&gt;-192.168.2.50:21-&lt;--timeout
|S-chain|-&lt;&gt;-127.0.0.1:5555-&lt;&gt;&lt;&gt;-192.168.2.50:80-&lt;&gt;&lt;&gt;-OK
Nmap scan report for 192.168.2.50
Host is up (0.0014s latency).

PORT   STATE  SERVICE
21/tcp closed ftp
22/tcp open   ssh
80/tcp open   http
</code></pre>

<h2 id="examples-and-tools">
<a class="anchor" href="#examples-and-tools" aria-hidden="true"><span class="octicon octicon-link"></span></a>Examples and Tools</h2>

<pre><code class="bash">doeti &lt;id_outside&gt; bash 

ssh -A -t -l jumphost 192.168.1.5 ssh -A -t -l inside_server 192.168.2.50
jumphost@192.168.1.5's password:
The authenticity of host '192.168.2.50 (192.168.2.50)' can't be established.
ECDSA key fingerprint is SHA256:X8zfVxXAe0YX8tPd4Ep5bU947Q9yANBvYC0TLR1w2FQ.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '192.168.2.50' (ECDSA) to the list of known hosts.
inside_server@192.168.2.50's password:
Linux 00d4aaa367c2 5.13.0-35-generic #40-Ubuntu SMP Mon Mar 7 08:03:10 UTC 2022 x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
inside_server@00d4aaa367c2:~$ 
</code></pre>

<p><a href="https://superuser.com/questions/96489/an-ssh-tunnel-via-multiple-hops" target="_blank" rel="noopener noreferrer">https://superuser.com/questions/96489/an-ssh-tunnel-via-multiple-hops</a></p>

<pre><code class="bash">doeti &lt;id_outside&gt; bash 

ssh -A -t -L 127.0.0.1:9999:127.0.0.1:9999 -l jumphost 192.168.1.5 ssh -A -t -L 127.0.0.1:9999:127.0.0.1:80 -l inside_server 192.168.2.50
</code></pre>

<pre><code class="bash">doeti id_outside bash 

curl 127.0.0.1:9999
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi from inside server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>

<p>###</p>

<p>nc at jumphost necessary</p>

<pre><code class="bash">doeti &lt;id_outside&gt; bash 

cd ~/.ssh

cat config
Host runthrough
ProxyCommand ssh -q jumphost@192.168.1.5 nc -q0 192.168.2.50 22
User inside_server
LocalForward 127.0.0.1:3333 127.0.0.1:80
</code></pre>

<p>ssh runthrough</p>

<p>Another window</p>

<pre><code class="bash">doeti &lt;id_outside&gt; bash 

netstat -atln | grep 127.0.0.1
tcp        0      0 127.0.0.11:39493        0.0.0.0:*               LISTEN

curl 127.0.0.1:3333
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi from inside server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>

<p>###</p>

<p>doeti id_outside bash
ssh -o ‘ProxyCommand=ssh -W %h:%p -q jumphost@192.168.1.5’ inside_server@192.168.2.50</p>

<p>###</p>

<p>doeti id_outside bash
ssh -o ‘ProxyCommand=ssh -W %h:%p -q jumphost@192.168.1.5’ inside_server@192.168.2.50 -L 127.0.0.1:7777:127.0.0.1:80</p>

<p>Another window
doeti id_outside bash</p>

<p>netstat -atlnp | grep 127
tcp        0      0 127.0.0.1:7777          0.0.0.0:*               LISTEN      101/ssh</p>

<p>curl 127.0.0.1:7777</p>
<h1>
<a class="anchor" href="#hi-from-inside-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hi from inside server</h1>

<p>###</p>

<pre><code class="bash">doeti &lt;id_outside&gt; bash 
ssh -J jumphost@192.168.1.5 inside_server@192.168.2.50 -L 127.0.0.1:9999:127.0.0.1:80
</code></pre>

<pre><code class="bash">
</code></pre>
<p>doeti &lt;id_outside&gt; bash
netstat -atlnp | grep 127 | grep 9999
tcp        0      0 127.0.0.1:9999          0.0.0.0:*               LISTEN      106/ssh</p>

<p>curl 127.0.0.1:9999
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi from inside server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
doeti <id_outside> bash</id_outside></p>

<h3 id="plink">
<a class="anchor" href="#plink" aria-hidden="true"><span class="octicon octicon-link"></span></a>plink</h3>

<pre><code class="bash">doeti &lt;id_jumphost&gt; bash 
wine plink.exe -x -a -T -C -noagent -ssh -l "outside" -pw "outside" -R 4444:192.168.2.50:80 192.168.1.3
</code></pre>

<pre><code class="bash">doeti &lt;id_outside&gt; bash

netstat -atnp | grep 4444
tcp        0      0 127.0.0.1:4444          0.0.0.0:*               LISTEN      -     

curl 127.0.0.1:4444
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi from inside server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>

<h3 id="sshuttle">
<a class="anchor" href="#sshuttle" aria-hidden="true"><span class="octicon octicon-link"></span></a>sshuttle</h3>

<p>https://github.com/sshuttle/sshuttle/issues/472</p>

<h3 id="socat">
<a class="anchor" href="#socat" aria-hidden="true"><span class="octicon octicon-link"></span></a>socat</h3>

<h3 id="ssf">
<a class="anchor" href="#ssf" aria-hidden="true"><span class="octicon octicon-link"></span></a>ssf</h3>

<pre><code class="bash">doeti &lt;id_outside&gt; bash 

cd ssf-linux-x86_64-3.0.0
./ssfd -p 80
</code></pre>

<pre><code class="bash">doeti &lt;id_jumphost&gt; bash 

cd ssf-linux-x86_64-3.0.0
./ssf -R 8888:192.168.2.50:80 192.168.1.3 -p 80
</code></pre>

<p><img src="/blog/assets/img/pivoting/portforwarding//ssf_0002.png" width="100%" alt="ssf remote tcp forward"></p>

<pre><code class="bash">doeti &lt;id_outside&gt; bash 

netstat -antl | grep 8888
tcp        0      0 127.0.0.1:8888          0.0.0.0:*               LISTEN

curl http://127.0.0.1:8888
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi from inside server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>

<p>ssfd in the other window should show</p>

<p><img src="/blog/assets/img/pivoting/portforwarding//ssf_0001.png" width="100%" alt="Connection to ssfd server"></p>

<h1 id="kubernetes">
<a class="anchor" href="#kubernetes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Kubernetes</h1>

<p>kportforwarding
telepresence</p>

<h2 id="faq">
<a class="anchor" href="#faq" aria-hidden="true"><span class="octicon octicon-link"></span></a>FAQ</h2>

<h3 id="docker-without-sudo">
<a class="anchor" href="#docker-without-sudo" aria-hidden="true"><span class="octicon octicon-link"></span></a>Docker without sudo</h3>

<p>If you have installed docker in the standard installation it runs without sudo.
This is not recommended from a security perspective as it allows privilege escalation:
<a href="https://flast101.github.io/docker-privesc/" target="_blank" rel="noopener noreferrer">https://flast101.github.io/docker-privesc/</a></p>

<h3 id="pool-overlaps">
<a class="anchor" href="#pool-overlaps" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pool overlaps</h3>
<p>If you get</p>

<pre><code class="bash">ERROR: Pool overlaps with other one on this address space
</code></pre>

<p>Change the IPs to ones that don’t bother you by changing the value x at 192.168.x.? or delete any clashing networks in the Docker network with</p>

<pre><code class="bash">sudo docker network ls
sudo docker network rm &lt;id&gt;
</code></pre>


            </div>
        </div>
    </div>
</article>

<hr>

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                <ul class="list-inline text-center">
                    <li class="list-inline-item">
                        <a href="https://secf00tprint.github.io/feed.xml">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                  </span>
                        </a>
                    </li>
                    <li class="list-inline-item">
                        <a href="https://github.com/secf00tprint" target="_blank" rel="noopener noreferrer">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                        </a>
                    </li>
                    <li class="list-inline-item">
                        <a href="https://www.xing.com/profile/Matthias_Altmann9" target="_blank" rel="noopener noreferrer">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fab fa-xing fa-stack-1x fa-inverse"></i>
                  </span>
                        </a>
                    </li>
                </ul>
                <p class="copyright text-muted">©2022 <a href="/blog/legal/legalstuff.html">Legal Stuff</a></p>
            </div>
        </div>
    </div>
</footer>

</body>

</html>
