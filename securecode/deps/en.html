<!DOCTYPE html>
<html lang="en">

<head>


<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Matthias Altmann">
<meta name="description" content="Secure Software Development using CI / Part I - Dependencies">

<title>Secure Software Development using CI</title>

<!-- Bootstrap core CSS -->
<link href="/blog/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

<!-- Custom fonts for this template -->
<link href="/blog/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

<!-- Custom styles for this template -->
<link href="/blog/css/clean-blog.min.css" rel="stylesheet">
<link href="/blog/css/buttons.css" rel="stylesheet">

<link rel="shortcut icon" href="/blog/assets/img/favicon.ico" type="image/x-icon">
<link rel="icon" href="/blog/assets/img/favicon.ico" type="image/x-icon">

<!-- For atom rss feed that browser can detect rss on side -->
<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Sitewide Atom feed" />

<script src="/blog/vendor/jquery/jquery.min.js"></script>
<script src="/blog/vendor/gsap/TweenMax.min.js"></script>

<script src="/blog/vendor/highlight/highlight.pack.js"></script>
<link href="/blog/vendor/highlight/styles/default.css" rel="stylesheet" type="text/css">
<script>hljs.initHighlightingOnLoad();</script>


</head>

<body>

<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
        <a class="navbar-brand" href="/blog/index.html">~/sec/f00tprint</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
            Menu
            <i class="fa fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/blog/index.html">Posts</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/blog/germancorner.html">German Corner</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/blog/payload-tester/lfirfi/en">Last Post</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/blog/about.html">About</a>
                </li>
            </ul>
        </div>
    </div>
</nav>


<!-- Page Header -->
<header class="masthead"
        
style="background-image:url('/blog/assets/img/home-matrix.png')"
        >
    <div class="overlay"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                <div class="page-heading">
                    <h1>Secure Software Development using CI</h1>
                    
                    <h2 class="subheading">Part I - Dependencies</h2>
                    
                    
                    <span class="meta">Posted on July 17, 2018</span>
                    

                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                <h4>Blog - content</h4>
<ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li>
  <li><a href="#security-vulnerabilities" id="markdown-toc-security-vulnerabilities">Security Vulnerabilities</a></li>
  <li><a href="#checking-on-the-command-line" id="markdown-toc-checking-on-the-command-line">Checking on the command line</a>    <ul>
      <li><a href="#owasp-dependency-check" id="markdown-toc-owasp-dependency-check">OWASP Dependency Check</a></li>
      <li><a href="#required-software" id="markdown-toc-required-software">Required software</a></li>
      <li><a href="#container-ids" id="markdown-toc-container-ids">Container IDs</a></li>
      <li><a href="#example-infrastructure" id="markdown-toc-example-infrastructure">Example infrastructure</a></li>
      <li><a href="#how-to-scan-a-java-project" id="markdown-toc-how-to-scan-a-java-project">How to scan a Java Project</a></li>
      <li><a href="#creating-a-git-server" id="markdown-toc-creating-a-git-server">Creating a git server</a></li>
    </ul>
  </li>
  <li><a href="#jenkins" id="markdown-toc-jenkins">Jenkins</a>    <ul>
      <li><a href="#get-jenkins-up-and-running" id="markdown-toc-get-jenkins-up-and-running">Get Jenkins up and running</a></li>
      <li><a href="#installing-dependency-check-as-a-plugin" id="markdown-toc-installing-dependency-check-as-a-plugin">Installing Dependency Check as a plugin</a></li>
      <li><a href="#deposit-git-credentials" id="markdown-toc-deposit-git-credentials">Deposit git credentials</a></li>
      <li><a href="#variants-owasp-dependency-check-jenkins" id="markdown-toc-variants-owasp-dependency-check-jenkins">Variants OWASP Dependency Check Jenkins</a></li>
      <li><a href="#suppressing-findings" id="markdown-toc-suppressing-findings">Suppressing Findings</a></li>
    </ul>
  </li>
  <li><a href="#sonarqube" id="markdown-toc-sonarqube">Sonarqube</a>    <ul>
      <li><a href="#installing-sonarqube" id="markdown-toc-installing-sonarqube">Installing Sonarqube</a></li>
      <li><a href="#checking-the-code" id="markdown-toc-checking-the-code">Checking the code</a></li>
    </ul>
  </li>
  <li><a href="#summary" id="markdown-toc-summary">Summary</a></li>
</ul>

<h1 id="introduction">Introduction</h1>

<p>Today’s software is largely based on libraries that are freely available. New features do not always have to be completely reimplemented if they are already publicly available. Often, a development team can fall back on libraries in the open source world. This is more cost-effective and also has the advantage that code included is often tested by multiple parties. It is not necessary to reinvent the wheel. Indeed, you can say that due to the complexity of today’s software, it is almost impossible to do modern project development without these dependencies of the open source world.</p>

<p>It is normal that larger project have uncountable numbers of dependencies that they need for different features.</p>

<h1 id="security-vulnerabilities">Security Vulnerabilities</h1>

<p>With a huge amount of dependencies it is only a matter of time before one of these dependencies has a security gap.
As a result, a risk to a system to become vulnerable to attacks will gradually increase if these issues are’nt resolved.</p>

<p>It’s not easy to find vulnerabilities in dependencies manually. This is due to different reasons:</p>

<ol>
  <li>The code is outsourced, so it is not maintained in the incorporating project.</li>
  <li>The external library is mostly zipped and compiled, which makes analysis difficult.</li>
  <li>Existing dependencies are usually not automatically lifted, as the resulting side effects are not transparently visible in a project, so that even if the developers fix the external dependency, it may not migrate directly into the project.</li>
</ol>

<p>That means by implication: The integrating project has to notice in another way that there are new issues in dependencies and do that in a timely manner.
But how can these faulty libraries be recognized and made visible at an early stage?</p>

<p>This first part of the Secure Software Development series describes how to check a Java program for dependencies. This is shown on the command line. After that I describe the whole thing in a downstream system called Jenkins.</p>

<p>Specifically, I will treat:</p>

<ul>
  <li>… how to check dependencies on the command line (<a href="#checking-on-the-command-line"><strong>section Checking on the command line</strong></a>).</li>
  <li>… can perform the same things in a downstream system called Jenkins. The main part refers to this system (<a href="#jenkins"><strong>section Jenkins</strong></a>).</li>
  <li>… how to check the same dependencies with a tool called Sonarqube. Sonarqube can be used to calculate metrics in a project (<a href="#sonarqube"><strong>section Sonarqube</strong></a>).</li>
  <li>… finally there’s a little summary of this blog (<a href="#summary"><strong>section Summary</strong></a>].</li>
</ul>

<p>First, let’s take a look at the underlying tool of this entire blog article:</p>

<h1 id="checking-on-the-command-line">Checking on the command line</h1>

<h2 id="owasp-dependency-check">OWASP Dependency Check</h2>

<p><a href="https://www.owasp.org/index.php/OWASP_Dependency_Check"><img src="/blog/assets/img/secure-code-ci/owaspdependencycheck.png" alt="owaspdependencycheck" width="100%" /></a></p>

<p><a href="https://www.owasp.org/index.php/OWASP_Dependency_Check"><strong>OWASP Dependency Check</strong></a> is an instrument to check the dependencies in your project for vulnerabilities: 
 It takes existing libraries of a project and tests them against a database for security holes. As a database, the tool uses the <a href="https://nvd.nist.gov/"><em>National Vulnerability Database</em></a>, <strong>NVD</strong> for short. 
In this database you can find for each library version the corresponding previously known reports.</p>

<p><img src="/blog/assets/img/secure-code-ci/nvd.png" alt="nvd" width="100%" /></p>

<p>Dependency Check can be used in two variants in the Java Universe:</p>

<ol>
  <li>Configured into a build management system</li>
  <li>Via command line</li>
</ol>

<p>The following description shows how to use it via command line and how to use a continuous integration and Inspection system.</p>

<p>A <a href="https://en.wikipedia.org/wiki/Continuous_Integration"><strong>continuous integration system</strong></a> allows you to automatically go over your latest code. In the simplest case, this is used to see if the latest can be build or if errors have occurred when new code was checked in.</p>

<p>On the other hand, a <strong>continuous inspection system</strong> shows immediately after reported to the system whether certain metrics of the code are fulfilled.</p>

<p>Both continuous integration and inspection report errors and warnings, e.g. directly via e-mail. They can now be supplemented with Dependency Check, so that after installing a new library, the developers can see if there exists problems at certain new point.</p>

<p>To illustrate everything, we will use a sample Docker infrastructure in this article, so that the reader can follow the individual steps directly by her/himself or test it, in case s/he wants to launch it in his project.</p>

<p>The steps here are given for a Mac, but should work similarly to other operating systems</p>

<h2 id="required-software">Required software</h2>

<p>First of all you need:</p>

<ol>
  <li>OWASP Dependency Checker</li>
  <li>Apache maven</li>
  <li>Docker</li>
</ol>

<p>The installation of 1 and 2 can be done with the following command:</p>

<pre><code class="bash">brew update &amp;&amp; brew install maven dependency-check
</code></pre>

<p>Docker can be installed according to <a href="https://www.docker.com/get-docker">its homepage</a>.</p>

<p>We will now use these tools throughout the rest of this guide.</p>

<h2 id="container-ids">Container IDs</h2>

<p>In the following description, <code class="highlighter-rouge">&lt;containerid_namedescontainer&gt;</code> means the Docker ID of the respective container. This ID can be determined using the <code class="highlighter-rouge">docker ps -a</code> command while Docker is running.</p>

<h2 id="example-infrastructure">Example infrastructure</h2>

<p>Next, we build an infrastructure with a continuous integration server.
For this we use <a href="https://jenkins.io/">Jenkins</a> and Docker.</p>

<p>First we create the necessary directory structure and build a local Git server. Important to note: 
The root directory <code class="highlighter-rouge">secureci</code> is the starting point for many of the following commands. The reader should therefore take care that he is at this level.</p>

<pre><code class="bash"># Clone repo with branch java
git clone -b java https://github.com/secf00tprint/secureci.git 
cd secureci
# Create mount directories for docker
./init.sh
</code></pre>

<p>After that the directory <code class="highlighter-rouge">secureci</code> should look like this:</p>

<p><img src="/blog/assets/img/secure-code-ci/secureciinit.png" alt="secureciinit" /></p>

<h2 id="how-to-scan-a-java-project">How to scan a Java Project</h2>

<p>To scan a Java project using OWASP Dependency Check on the command line, the following steps can be performed in the root directory of the <code class="highlighter-rouge">secureci</code> project:</p>

<p>1 Setting up a Java example project:</p>

<pre><code class="bash">cd localproject

mvn archetype:generate \
-DarchetypeGroupId=org.apache.maven.archetypes \
-DarchetypeArtifactId=maven-archetype-quickstart \
-DarchetypeVersion=1.3 \
-DgroupId=de.mydomain \
-DartifactId=old_depproject \
-Dversion=1.0-SNAPSHOT \
-Dpackage=de.mydomain -B

cd old_depproject
</code></pre>

<p>2 Delete old dependencies and download the up-to-date dependencies into the project:</p>

<pre><code class="bash">mvn clean dependency:copy-dependencies
</code></pre>

<p>3 Copy all dependencies to a subdirectory <code class="highlighter-rouge">alllibs</code>:</p>

<pre><code class="bash">if [ -d alllibs ]; then; rm -rf ./alllibs; fi;\
mkdir ./alllibs;\
find . -iname '*.jar' -exec cp {} ./alllibs/ \; 2&gt; /dev/null;\
find . -iname '*.class' -exec cp {} ./alllibs/ \; 2&gt; /dev/null
</code></pre>

<p>4 Start the scanner:</p>

<pre><code class="bash">dependency-check \
--project "Example Project" \
-s ./alllibs \
-l dependency.log
</code></pre>

<p><img src="/blog/assets/img/secure-code-ci/depcheckout.png" alt="depcheckout" width="100%" /></p>

<p>5 Evaluation of results:</p>

<pre><code class="bash">open dependency-check-report.html
</code></pre>

<p>In order to cause a result with issues, we add a library to the dependencies used by the project that contains a security vulnerability.</p>

<p>For this we append a <code class="highlighter-rouge">dependencies</code> section in the file<code class="highlighter-rouge"> pom.xml</code>, which Maven uses for building:</p>

<pre><code class="xml">&#x3C;dependencies&#x3E;
 ...
      &#x3C;dependency&#x3E;
         &#x3C;groupId&#x3E;commons-fileupload&#x3C;/groupId&#x3E;
         &#x3C;artifactId&#x3E;commons-fileupload&#x3C;/artifactId&#x3E;
         &#x3C;version&#x3E;1.2.2&#x3C;/version&#x3E;
     &#x3C;/dependency&#x3E;
&#x3C;/dependencies&#x3E;
</code></pre>

<p>and perform steps 2 to 5 again.</p>

<p>Now there should be an issue in the result report:</p>

<pre><code class="bash">open dependency-check-report.html
</code></pre>

<p><img src="/blog/assets/img/secure-code-ci/reportwithfinding.png" alt="reportwithfinding" width="100%" /></p>

<h2 id="creating-a-git-server">Creating a git server</h2>

<p>Now we can build the git server (The server is based on the code the <a href="https://github.com/jkarlosb/git-server-docker">project jkarlosb git server</a> - 
thanks to this really cool docker image):</p>

<pre><code class="bash">cd gitserver
docker build -t gitserver .
cd ..
</code></pre>

<p>Create a key pair (double press enter for the passphrase):</p>

<pre><code class="bash">cd mykeys
ssh-keygen -t rsa -f gitkey
cp gitkey.pub ../mnt/gitserver/keys
cd ..
</code></pre>

<p>Now we can run the git server:
We have to make sure that we are in the root directory.</p>

<pre><code class="bash">docker run -d -p 127.0.0.1:22:22 \
-v `pwd`/mnt/gitserver/keys:/git-server/keys \
-v `pwd`/mnt/gitserver/repos:/git-server/repos \
gitserver
</code></pre>

<p>We can check whether we can connect to the server (root directory!) using:</p>

<pre><code class="bash">ssh git@127.0.0.1 -i mykeys/gitkey
</code></pre>

<h4 id="registration-possible">Registration possible</h4>

<p>As response we should see:</p>

<pre><code class="bash">Welcome to git-server-docker!
You've successfully authenticated, but I do not
provide interactive shell access.
Connection to 127.0.0.1 closed.
</code></pre>

<h4 id="no-registration-possible">No registration possible</h4>

<p>The following error message may appear, in case we should already have assigned an IP:</p>

<pre><code class="bash">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
</code></pre>

<p>To solve this, we open the file <code class="highlighter-rouge">~/.ssh/known_hosts</code> and remove the corresponding line containing the IP or comment it out with<code class="highlighter-rouge">#</code>.</p>

<h3 id="creating-an-external-git-repository">Creating an external git repository</h3>

<p>Now we create a git project locally and copy the repo into our git server:</p>

<pre><code class="bash">cd localproject
git init --shared=true
git add .
git commit -m &#x22;my first commit&#x22;
cd ..
git clone --bare localproject mnt/gitserver/repos/project.git
docker restart &#x3C;containerid_gitserver&#x3E;
</code></pre>

<p>We can now test if the code has been committed by:</p>

<pre><code class="bash">ssh-add mykeys/gitkey
mkdir temp &amp;&amp; cd temp
git clone ssh://git@127.0.0.1/git-server/repos/project.git
cd ..
</code></pre>

<p>Then the temp directory can be deleted by</p>

<pre><code class="bash">rm -rf temp
</code></pre>

<h1 id="jenkins">Jenkins</h1>

<p>In the following chapter we now build and use the continuous integration system named <a href="https://jenkins.io/"><strong>Jenkins</strong></a>.</p>

<p><img src="/blog/assets/img/secure-code-ci/jenkins.png" alt="jenkins" width="100%" /></p>

<h2 id="get-jenkins-up-and-running">Get Jenkins up and running</h2>

<p>Next we start Jenkins.</p>

<p>For this we go to the directory <code class="highlighter-rouge">conintserver</code>:</p>

<pre><code class="bash">cd conintserver
</code></pre>

<p>and build the image:</p>

<pre><code class="bash">docker build -t conintserver .
cd ..
</code></pre>

<p>Then we start the server from the root directory with:</p>

<pre><code class="bash">docker run -p 127.0.0.1:8080:8080 -p 127.0.0.1:50000:50000 -v `pwd`/mnt/conintserver/jkhome:/var/jenkins_home -v `pwd`/mnt/conintserver/project/:/home conintserver
</code></pre>

<p>And open the server in the browser:</p>

<pre><code class="bash">open http://127.0.0.1:8080
</code></pre>

<p>There is an entry in the docker console:</p>

<pre><code class="bash">*************************************************************
*************************************************************
*************************************************************

Jenkins initial setup is required. An admin user has been created and a password generated.
Please use the following password to proceed to installation:

XXXXXXXXX

This may also be found at: /var/jenkins_home/secrets/initialAdminPassword

*************************************************************
*************************************************************
*************************************************************
</code></pre>

<p>We copy the code <code class="highlighter-rouge">XXXXXXXXX</code> from the logs into the browser input field.</p>

<p>If the output from Docker is currently unavailable, it can be viewed by using</p>

<pre><code class="bash">docker logs &#x3C;containerid_jenkins&#x3E; --tail 30
</code></pre>

<p><img src="/blog/assets/img/secure-code-ci/unlockjenkins.png" alt="unlock_jenkins" width="100%" /></p>

<p><img src="/blog/assets/img/secure-code-ci/unlockjenkins2.png" alt="unlock_jenkins2" width="100%" /></p>

<p>Next we click on ‘Continue’</p>

<p>and on ‘Install suggested plugins’:</p>

<p><img src="/blog/assets/img/secure-code-ci/installsuggestedplugins.png" alt="installsuggestedplugins" width="100%" /></p>

<p><img src="/blog/assets/img/secure-code-ci/installsuggestedplugins2.png" alt="installsuggestedplugins2" width="100%" /></p>

<p>In the following form we enter a name, password and e-mail and remember this data:</p>

<p><img src="/blog/assets/img/secure-code-ci/installsuggestedplugins2.png" alt="installsuggestedplugins2" width="100%" /></p>

<p><img src="/blog/assets/img/secure-code-ci/createadmin.png" alt="createadmin" width="100%" /></p>

<p>So, for example:</p>

<table>
  <thead>
    <tr>
      <th>Username</th>
      <th style="text-align: center">Password</th>
      <th style="text-align: center">Full name</th>
      <th style="text-align: right">E-Mail</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>secf00tprint</td>
      <td style="text-align: center">e.g. by using <code class="highlighter-rouge">pwgen -ync 40</code> one the command line*</td>
      <td style="text-align: center">secf00tprint</td>
      <td style="text-align: right"> youraccount@yourdomain.tld</td>
    </tr>
  </tbody>
</table>

<p>* pwgen can be installed by entering</p>

<pre><code class="bash">brew install pwgen
</code></pre>

<p>Click on ‘Save and Continue’.</p>

<p>We set the Jenkins URL,</p>

<p><img src="/blog/assets/img/secure-code-ci/jenkinsurl.png" alt="jenkinsurl" width="100%" /></p>

<p>and lastly we save and finish.</p>

<p><img src="/blog/assets/img/secure-code-ci/startusingjenkins.png" alt="startusingjenkins" width="100%" /></p>

<h2 id="installing-dependency-check-as-a-plugin">Installing Dependency Check as a plugin</h2>

<ol>
  <li>First, we select ‘Manage Jenkins’:
<img src="/blog/assets/img/secure-code-ci/installdepcheck1.png" alt="installdepcheck1" width="100%" /></li>
  <li>Then ‘Manage Plugins’:
<img src="/blog/assets/img/secure-code-ci/installdepcheck2.png" alt="installdepcheck2" width="100%" /></li>
  <li>‘Available’ plugins:
<img src="/blog/assets/img/secure-code-ci/installdepcheck3.png" alt="installdepcheck3" width="100%" /></li>
  <li>OWASP Dependency Check:
<img src="/blog/assets/img/secure-code-ci/installdepcheck4.png" alt="installdepcheck4" width="100%" />
<img src="/blog/assets/img/secure-code-ci/installdepcheck5.png" alt="installdepcheck5" width="100%" /></li>
  <li>We choose ‘Download now and install after restart’:
<img src="/blog/assets/img/secure-code-ci/installdepcheck6.png" alt="installdepcheck6" width="100%" /></li>
  <li>We click on ‘Restart Jenkins when installation is complete’
<img src="/blog/assets/img/secure-code-ci/installdepcheck7.png" alt="installdepcheck7" width="100%" />
<img src="/blog/assets/img/secure-code-ci/installdepcheck8.png" alt="installdepcheck8" width="100%" /></li>
</ol>

<p>We look into the docker logs until we see <code class="highlighter-rouge">INFO: Jenkins is fully up and running</code>.</p>

<p>At the end we go to <code class="highlighter-rouge">http://127.0.0.1:8080</code> and log in with the noted credentials.</p>

<h2 id="deposit-git-credentials">Deposit git credentials</h2>

<p>First, we have to deposit the appropriate credentials in Jenkins for our git docker:</p>

<p>For this we click on ‘Credentials’ in the main menu :</p>

<p><img src="/blog/assets/img/secure-code-ci/addcredentials1.png" alt="addcredentials1" /></p>

<p>Then to ‘Global Credentials’, ‘Add Credentials’:</p>

<p><img src="/blog/assets/img/secure-code-ci/addcredentials2.png" alt="addcredentials2" /></p>

<p>Choose ‘SSH Username with private key’:</p>

<p><img src="/blog/assets/img/secure-code-ci/addcredentials3.png" alt="addcredentials3" width="100%" /></p>

<p>Enter ‘git’ as user and the private key:</p>

<p><img src="/blog/assets/img/secure-code-ci/addcredentials4.png" alt="addcredentials4" width="100%" /></p>

<p>The private key for copying can be displayed by using</p>

<pre><code class="bash">cat mykeys/gitkey
</code></pre>

<p>on the console.</p>

<p>Click on ‘Ok’, so the credentials for our git are deposited in Jenkins.</p>

<h2 id="variants-owasp-dependency-check-jenkins">Variants OWASP Dependency Check Jenkins</h2>

<p>Now there are two ways to run the OWASP Dependency Check on your project:</p>

<p>Either as part of a pipeline build or as part of a standard GUI build.</p>

<p>In the following both variants are explained.</p>

<p>The two build variants differ:</p>

<p>If you use the <strong>Jenkins Pipeline Build</strong>, the project team describes the steps of the build in a text file.
This can be done either through a Groovy-like scripting language or in a declarative notation. The following examples use the declarative notation.</p>

<p>With a <strong>standard GUI build</strong>, the project team clicks the corresponding points using the GUI.</p>

<p>Advantage of the GUI:</p>

<p>The GUI is initially easier to understand when creating the processes through visualization with graphics. The syntax and commands of the pipeline definitions need not be known.</p>

<p>Advantage of the pipeline:</p>

<p>During the build, the defined individual steps are nicely graphically displayed. Individual steps of the log can be opened by clicking and the programmer, if configured, can locally edit and view the script without having to access jenkins via a browser.</p>

<h3 id="set-up-jenkins-pipeline">Set up jenkins pipeline</h3>

<h4 id="defining-global-tools">Defining global tools</h4>

<p>We select in the main menu under ‘Manage Jenkins’, ‘Global Tool Configuration’:</p>

<p><img src="/blog/assets/img/secure-code-ci/globaltoolconfiguration1.png" alt="globaltoolconfiguration1" width="100%" /></p>

<p>The names defined here will be used later by the pipeline.</p>

<p>So we set the name ‘Maven 3.3.9’ under ‘Maven’ and select ‘Maven 3.3.9’:</p>

<p><img src="/blog/assets/img/secure-code-ci/globaltoolconfiguration2.png" alt="globaltoolconfiguration2" width="100%" /></p>

<p>and click on ‘Save’.</p>

<h4 id="nvd-update-pipeline-item">NVD Update Pipeline Item</h4>

<p>In order not to have to download the NVD database completely every time, you should first define a periodic job that, independent of the actual analysis, updates the database so that it can be used quickly by the exam job.</p>

<p>For this we create a pipeline project:</p>

<p>We click on ‘New-Item’:</p>

<p><img src="/blog/assets/img/secure-code-ci/createnewnvdupdatepipeline.png" alt="createnewnvdupdatepipeline" /></p>

<p>Select ‘pipeline project’, assign a name (here we use ‘depcheck-nvdupdate’) and click on ‘Ok’:</p>

<p><img src="/blog/assets/img/secure-code-ci/createnewnvdupdatepipeline2.png" alt="createnewnvdupdatepipeline2" /></p>

<p>As Build Triggers, we select ‘Build periodically’ and enter ‘@daily’, then the database will be updated daily:</p>

<p><img src="/blog/assets/img/secure-code-ci/createnewnvdupdatepipeline3.png" alt="createnewnvdupdatepipeline3" width="100%" /></p>

<p>Under Pipeline we enter the following declaration and click on ‘Save’:</p>

<pre><code class="bash">pipeline {
    agent any
    stages {
        stage ('Dependency Check Update') {
            steps {
                dependencyCheckUpdateOnly '/var/jenkins_home/depcheck/nvdupdates'
            }
        }
    }
}
</code></pre>

<p><img src="/blog/assets/img/secure-code-ci/createnewnvdupdatepipeline4.png" alt="createnewnvdupdatepipeline4" width="100%" /></p>

<p>This defines that the update will be placed on the Jenkins in the directory <code class="highlighter-rouge">/var/jenkins_home/depcheck/nvdupdates</code>.</p>

<p>Then we build the database via ‘Build Now’:</p>

<p><img src="/blog/assets/img/secure-code-ci/runnvdupdate1.png" alt="runnvdupdate1" /></p>

<p>The output should look like this:</p>

<p><img src="/blog/assets/img/secure-code-ci/runnvdupdate2.png" alt="runnvdupdate2" /></p>

<p>The console output can be displayed by the blue ball:</p>

<p><img src="/blog/assets/img/secure-code-ci/runnvdupdate3.png" alt="runnvdupdate3" /></p>

<p>and might look like this:</p>

<p><img src="/blog/assets/img/secure-code-ci/runnvdupdate4.png" alt="runnvdupdate4" /></p>

<h4 id="owasp-dependency-check-pipeline-item">OWASP Dependency Check Pipeline Item</h4>

<p>Now we set up a pipeline project that checks our code:</p>

<p>We click on ‘New Item’ in the main menu as in the previous chapter, select ‘Pipeline’ and name it as e.g. ‘Project pipeline \ _depcheck’.</p>

<p>Now, under ‘Pipeline’, select ‘Pipeline script from SCM’. This means we will pull the pipeline script out of our repository so we can define and change it locally:</p>

<p><img src="/blog/assets/img/secure-code-ci/depcheckpipeline1.png" alt="depcheckpipeline1" width="100%" /></p>

<p>Here we set the repository URL for our docker-git-server.</p>

<p>To determine the internal IP of the Docker server, we enter the following on the host:</p>

<pre><code class="bash">docker inspect &#x3C;containerid_gitserver&#x3E; |grep -i &#x22;\&#x22;ipaddress&#x22;
</code></pre>

<p>We use it and enter as repository URL:</p>

<pre><code class="bash">ssh://git@&#x3C;ip_gitserver_docker&#x3E;/git-server/repos/project.git
</code></pre>

<p>e.g.:</p>

<pre><code class="bash">ssh://git@172.17.0.4/git-server/repos/project.git
</code></pre>

<p>Next, we select the previously defined credentials - in this case the selection marked ‘git’ in the drop-down menu:</p>

<p><img src="/blog/assets/img/secure-code-ci/depcheckpipeline2.png" alt="depcheckpipeline2" /></p>

<p>After that the repository should be recognized.</p>

<p>Next, we put <code class="highlighter-rouge">Jenkinsfile</code> out of our repository as a pipeline script.</p>

<p>Then we click on ‘Save’.</p>

<h5 id="defining-a-local-jenkinsfile---introduction">Defining a local Jenkinsfile - Introduction</h5>

<p>We go to our local git project:</p>

<pre><code class="bash">cd localproject
</code></pre>

<p>and create the file <code class="highlighter-rouge">Jenkinsfile</code> in the root directory with the following content:</p>

<pre><code class="bash">pipeline {
    agent any
    tools {
        maven 'Maven 3.3.9'
    }
    stages {
        /*
        stage ('Initialize') {
            steps {
                sh 'echo === init stage ==='
                // e.g. "M2_HOME = ${M2_HOME}"
            }
        }

        stage ('Build') {
            steps {
                sh 'echo === build stage ==='
                sh 'cd old_depproject; mvn -Dmaven.test.failure.ignore=true install'
            }
        }

        stage ('Test') {
            steps {
                sh 'echo === test stage ==='
            }
        }
        */

        stage ('Dependency Check') {
            steps {
                sh 'echo === security stage ==='
                sh 'echo === OWASP dependency check ==='
                sh 'cd old_depproject; mvn clean dependency:copy-dependencies'
                sh 'cd old_depproject; ./aggregatefordepcheck.sh'
                dependencyCheckAnalyzer scanpath: 'old_depproject', \
                  outdir: 'depcheck/report', \
                  datadir: '/var/jenkins_home/depcheck/nvdupdates', \
                  hintsFile: '', \
                  includeVulnReports: true, \
                  includeCsvReports: true, \
                  includeHtmlReports: true, \
                  includeJsonReports: true, \
                  isAutoupdateDisabled: true, \
                  skipOnScmChange: false, \
                  skipOnUpstreamChange: false, \
                  suppressionFile: '', \
                  zipExtensions: ''

               dependencyCheckPublisher pattern: 'depchec/report/dependency-check-report.xml', \
                  failedTotalAll: '0', \
                  usePreviousBuildAsReference: false
            }
        }
    }
}
</code></pre>

<h5 id="defining-a-local-jenkinsfile---possible-parameters">Defining a local Jenkinsfile - Possible parameters</h5>

<p>The parameters defined here for the OWASP Dependency Check Plugin can also be looked up at:</p>

<p><a href="https://jenkins.io/doc/pipeline/steps/dependency-check-jenkins-plugin/">https://jenkins.io/doc/pipeline/steps/dependency-check-jenkins-plugin/</a></p>

<p>Essentially you can control:</p>

<p>DependencyCheckAnalyzer:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Parameter</th>
      <th style="text-align: center">Description</th>
      <th style="text-align: center">Type</th>
      <th style="text-align: center">Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">scanpath</code></td>
      <td style="text-align: center">Path for scanning</td>
      <td style="text-align: center"><code class="highlighter-rouge">String</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">'old_depproject'</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">outdir</code></td>
      <td style="text-align: center">Output folder</td>
      <td style="text-align: center"><code class="highlighter-rouge">String</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">'depcheck/report'</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">datadir</code></td>
      <td style="text-align: center">Data folder</td>
      <td style="text-align: center"><code class="highlighter-rouge">String</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">'/var/jenkins_home/depcheck/nvdupdates'</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">suppressionFile</code></td>
      <td style="text-align: center">Suppression File (more on that below)</td>
      <td style="text-align: center"><code class="highlighter-rouge">String</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">'suppression.xml'</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">hintsFile</code></td>
      <td style="text-align: center">Used to determine <a href="https://jeremylong.github.io/DependencyCheck/general/hints.html">false negatives</a></td>
      <td style="text-align: center"><code class="highlighter-rouge">String</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">'hintsfile.xml'</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">zipExtensions</code></td>
      <td style="text-align: center">Specifies which file extensions are treated as zip</td>
      <td style="text-align: center"><code class="highlighter-rouge">String</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">'jar'</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">isAutoupdateDisabled</code></td>
      <td style="text-align: center">Disables the automatic NVD update during a build</td>
      <td style="text-align: center"><code class="highlighter-rouge">Boolean</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">'true'</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">includeHtmlReports</code></td>
      <td style="text-align: center">Generates an optional HTML report</td>
      <td style="text-align: center"><code class="highlighter-rouge">Boolean</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">'false'</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">includeVulnReports</code></td>
      <td style="text-align: center">Generates an optional vulnerability report</td>
      <td style="text-align: center"><code class="highlighter-rouge">Boolean</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">'true'</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">includeJsonReports</code></td>
      <td style="text-align: center">Generates an optional JSON report</td>
      <td style="text-align: center"><code class="highlighter-rouge">Boolean</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">'false'</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">includeCsvReports</code></td>
      <td style="text-align: center">Generates an optional CSV report</td>
      <td style="text-align: center"><code class="highlighter-rouge">Boolean</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">'true'</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">skipOnScmChange</code></td>
      <td style="text-align: center">Skip if triggered by SCM changes</td>
      <td style="text-align: center"><code class="highlighter-rouge">Boolean</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">'false'</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">skipOnUpstreamChange </code></td>
      <td style="text-align: center">Skip if triggered by upstream changes</td>
      <td style="text-align: center"><code class="highlighter-rouge">Boolean</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">'true'</code></td>
    </tr>
  </tbody>
</table>

<p>DependencyCheckPublisher:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Parameter</th>
      <th style="text-align: center">Description</th>
      <th style="text-align: center">Typ</th>
      <th style="text-align: center">Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">pattern</code></td>
      <td style="text-align: center">Dependency Check result file(s)</td>
      <td style="text-align: center"><code class="highlighter-rouge">String</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">''**/dependency-check-report.xml'</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">usePreviousBuildAsReference</code></td>
      <td style="text-align: center">Use the previous build</td>
      <td style="text-align: center"><code class="highlighter-rouge">Boolean</code></td>
      <td style="text-align: center"><code class="highlighter-rouge">'false'</code></td>
    </tr>
  </tbody>
</table>

<p>By using certain parameters, you can tell the DependencyCheckPublisher call which feedback it should give with different findings.</p>

<p>Here we take the following parameters:</p>

<pre><code class="bash">failedTotalAll: '0' 
</code></pre>

<p>that is, the build fails or turns red as soon as at least one finding is detected.</p>

<p>You could also set</p>

<pre><code class="bash">unstableTotalAll: '0' 
</code></pre>
<p>.</p>

<p>Then the build would turn yellow or unstable as soon as at least one finding is recognized.</p>

<p>In addition to these two relatively basic settings, more detailed adjustment can be provided marking a build yellow or red.</p>

<p>The following parameters can be defined as of July 2018:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Parameter</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">failedNewAll</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">failedNewHigh</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">failedNewLow</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">failedNewNormal</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">failedTotalAll</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">failedTotalHigh</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">failedTotalLow</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">failedTotalNormal</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">unstableNewAll</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">unstableNewHigh</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">unstableNewLow</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">unstableNewNormal</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">unstableTotalAll</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">unstableTotalHigh</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">unstableTotalLow</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="highlighter-rouge">unstableTotalNormal</code></td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<h5 id="defining-a-local-jenkinsfile---aggregate-dependencies">Defining a local Jenkinsfile - Aggregate Dependencies</h5>

<p>To build the dependencies, we create the following shell script <code class="highlighter-rouge">aggregatefordepcheck.sh</code> under <code class="highlighter-rouge">localproject / olddeproject</code>:</p>

<pre><code class="bash">#! /bin/bash
[[ -d alllibs ]] || mkdir ./alllibs; find . -iname '*.jar' -exec cp {} ./alllibs/ 2&gt;/dev/null \; ; find . -iname '*.class' -exec cp {} ./alllibs/ 2&gt;/dev/null \;
</code></pre>

<h5 id="defining-a-local-jenkinsfile---final-pipeline-script">Defining a local Jenkinsfile - Final pipeline script</h5>

<p>We push everything together in our Docker repo:</p>

<pre><code class="bash">git add .
git commit -m "Jenkinsfile and Maven Aggregate Script"
git push origin master
</code></pre>

<p>If we now select our item <code class="highlighter-rouge">projectpipeline_depcheck</code> in Jenkins and click on ‘Build Now’, the following output should appear:</p>

<p><img src="/blog/assets/img/secure-code-ci/rundepcheck1.png" alt="rundepcheck1" /></p>

<p>or as console output:</p>

<p><img src="/blog/assets/img/secure-code-ci/rundepcheck2.png" alt="rundepcheck2" width="100%" /></p>

<p>From the logs you can also see the path of the report on the Jenkins server:</p>

<pre><code class="bash">open ../mnt/conintserver/jkhome/workspace/projectpipeline_depcheck/depcheck/report/dependency-check-report.html
</code></pre>

<p><img src="/blog/assets/img/secure-code-ci/rundepcheck3.png" alt="rundepcheck3" width="100%" /></p>

<h4 id="test-if-it-works">Test if it works</h4>

<p>Next we add a dependency which is problematic.</p>

<p>We add to our pom.xml:</p>

<pre><code class="xml">&#x3C;!-- https://mvnrepository.com/artifact/commons-fileupload/commons-fileupload --&#x3E;
&#x3C;dependency&#x3E;
    &#x3C;groupId&#x3E;commons-fileupload&#x3C;/groupId&#x3E;
    &#x3C;artifactId&#x3E;commons-fileupload&#x3C;/artifactId&#x3E;
    &#x3C;version&#x3E;1.2.2&#x3C;/version&#x3E;
&#x3C;/dependency&#x3E;
</code></pre>

<p>we go to <code class="highlighter-rouge">localproject/old_depproject</code> and augment the dependencies section:</p>

<p><img src="/blog/assets/img/secure-code-ci/checkdepcheckpipeline1.png" alt="checkdepcheckpipeline1" width="100%" /></p>

<p>Then we push the new <code class="highlighter-rouge">pom.xml</code> and rebuild the item.</p>

<pre><code class="bash">git add pom.xml
git commit -m "add old commons fileupload"
git push origin master
</code></pre>

<p><img src="/blog/assets/img/secure-code-ci/checkdepcheckpipeline2.png" alt="checkdepcheckpipeline2" /></p>

<p>Result - the build should fail:</p>

<p><img src="/blog/assets/img/secure-code-ci/checkdepcheckpipeline3.png" alt="checkdepcheckpipeline3" width="100%" />
<img src="/blog/assets/img/secure-code-ci/checkdepcheckpipeline4.png" alt="checkdepcheckpipeline4" width="100%" /></p>

<p>and the corresponding HTML taken from the Jenkins logs also reflects the issue:</p>

<pre><code class="bash">open ../mnt/conintserver/jkhome/workspace/projectpipeline_depcheck/depcheck/report/dependency-check-report.html
</code></pre>

<p><img src="/blog/assets/img/secure-code-ci/checkdepcheckpipeline5.png" alt="checkdepcheckpipeline5" width="100%" /></p>

<h4 id="modifying-the-test-evaluation">Modifying the test evaluation</h4>

<p>If you do not want to create a red traffic light right away, 
you can also use <code class="highlighter-rouge">unstableTotalAll</code> instead of<code class="highlighter-rouge"> failedTotalAll</code> in the Jenkinsfile:</p>

<pre><code class="bash">&#x3E; cat Jenkinsfile                                                                     
pipeline {
    agent any
    tools {
        maven &#x27;Maven 3.3.9&#x27;
    }
    stages {
        /*
        stage (&#x27;Initialize&#x27;) {
            steps {
                sh &#x27;echo === init stage ===&#x27;
                // e.g. &#x22;M2_HOME = ${M2_HOME}&#x22;
            }
        }

        stage (&#x27;Build&#x27;) {
            steps {
                sh &#x27;echo === build stage ===&#x27;
                sh &#x27;cd old_depproject; mvn -Dmaven.test.failure.ignore=true install&#x27;
            }
        }

        stage (&#x27;Test&#x27;) {
            steps {
                sh &#x27;echo === test stage ===&#x27;
            }
        }
        */

        stage (&#x27;Dependency Check&#x27;) {
            steps {
                sh &#x27;echo === security stage ===&#x27;
                sh &#x27;echo === OWASP dependency check ===&#x27;
                sh &#x27;cd old_depproject; mvn clean dependency:copy-dependencies&#x27;
                sh &#x27;cd old_depproject; ./aggregatefordepcheck.sh&#x27;
                dependencyCheckAnalyzer scanpath: &#x27;old_depproject&#x27;, \
                  outdir: &#x27;depcheck/report&#x27;, \
                  datadir: &#x27;/var/jenkins_home/depcheck/nvdupdates&#x27;, \
                  hintsFile: &#x27;&#x27;, \
                  includeVulnReports: true, \
                  includeCsvReports: true, \
                  includeHtmlReports: true, \
                  includeJsonReports: true, \
                  isAutoupdateDisabled: true, \
                  skipOnScmChange: false, \
                  skipOnUpstreamChange: false, \
                  suppressionFile: &#x27;&#x27;, \
                  zipExtensions: &#x27;&#x27;

               dependencyCheckPublisher pattern: &#x27;depcheck/report/dependency-check-report.xml&#x27;, \
                  unstableTotalAll: &#x27;0&#x27;, \
                  usePreviousBuildAsReference: false
            }
        }
    }
}
</code></pre>

<p><img src="/blog/assets/img/secure-code-ci/depchecksetwarning1.png" alt="depchecksetwarning1" width="100%" />
<img src="/blog/assets/img/secure-code-ci/depchecksetwarning2.png" alt="depchecksetwarning2" width="100%" /></p>

<h3 id="jenkins-standard-build">Jenkins Standard Build</h3>

<p>In addition to the definition of pipeline scripts, the OWASP Dependency Check plugin can also be clicked via the GUI. This is the old default way.</p>

<p>In doing so, the configuration is clearer, but the output is not as modular and understandable afterwards.</p>

<h4 id="nvd-update-gui-item">NVD Update GUI Item</h4>

<p>The configuration can be made in these steps:</p>

<ol>
  <li>‘New Item’:
<img src="/blog/assets/img/secure-code-ci/createnewnvdupdategui1.png" alt="createnewnvdupdategui1" width="100%" /></li>
  <li>‘Build Triggers’ ‘Build periodically’:
<img src="/blog/assets/img/secure-code-ci/createnewnvdupdategui2.png" alt="createnewnvdupdategui2" width="100%" /></li>
  <li>‘Build’ ‘Add build step’ ‘Invoke Dependency-Check NVD update only’:
<img src="/blog/assets/img/secure-code-ci/createnewnvdupdategui3.png" alt="createnewnvdupdategui3" width="100%" /></li>
  <li>Data directory: <code class="highlighter-rouge">/var/jenkins_home/depcheck/nvdupdates</code>
<img src="/blog/assets/img/secure-code-ci/createnewnvdupdategui4.png" alt="createnewnvdupdategui4" width="100%" /></li>
  <li>‘Save’</li>
</ol>

<p>Then start the build using ‘Build Now’.</p>

<p><img src="/blog/assets/img/secure-code-ci/createnewnvdupdategui5.png" alt="createnewnvdupdategui5" width="100%" /></p>

<p>The console output should look like this:</p>

<p><img src="/blog/assets/img/secure-code-ci/createnewnvdupdategui6.png" alt="createnewnvdupdategui6" width="100%" /></p>

<h4 id="owasp-dependency-check-gui-item">OWASP Dependency Check GUI Item</h4>

<p>Based on the NVD database generated by Jenkins pipeline script or GUI config, we can now test the dependencies as follows:</p>

<p><img src="/blog/assets/img/secure-code-ci/depcheckgui1.png" alt="depcheckgui1" /></p>

<p>We click on ‘Ok’.</p>

<p>Under ‘Source Code Management’ we enter the Git server contained in the Docker network:</p>

<pre><code class="bash">ssh://git@172.17.0.4/git-server/repos/project.git
</code></pre>

<p><img src="/blog/assets/img/secure-code-ci/depcheckgui2.png" alt="depcheckgui2" width="100%" /></p>

<p>and select the credentials ‘git’:</p>

<p><img src="/blog/assets/img/secure-code-ci/depcheckgui3.png" alt="depcheckgui3" width="100%" />
<img src="/blog/assets/img/secure-code-ci/depcheckgui4.png" alt="depcheckgui4" width="100%" /></p>

<p>Then under ‘Build’ we go to ‘Invoke top-level Maven targets’:</p>

<p><img src="/blog/assets/img/secure-code-ci/depcheckgui5a.png" alt="depcheckgui5a" /></p>

<p>Now select the installed global tool:</p>

<p><img src="/blog/assets/img/secure-code-ci/depcheckgui5b.png" alt="depcheckgui5b" width="100%" /></p>

<p>Now we choose ‘Advanced’. As goals we set <code class="highlighter-rouge">clean dependency: copy-dependencies</code> and as location we choose<code class="highlighter-rouge"> pom.xml</code></p>

<p><img src="/blog/assets/img/secure-code-ci/depcheckgui5c.png" alt="depcheckgui5c" width="100%" /></p>

<p>Under ‘Build’ we add another build step using ‘Add build steps’: ‘Invoke Dependency-Check analysis’:</p>

<p><img src="/blog/assets/img/secure-code-ci/depcheckgui6.png" alt="depcheckgui6" /></p>

<p>We choose ‘Advanced’ and then:</p>

<ul>
  <li>Path to scan: <code class="highlighter-rouge">old_depproject</code></li>
  <li>Output directory: <code class="highlighter-rouge">depcheck/report</code></li>
  <li>Data directory: <code class="highlighter-rouge">/var/jenkins_home/depcheck/nvdupdates</code></li>
</ul>

<p><img src="/blog/assets/img/secure-code-ci/depcheckgui7.png" alt="depcheckgui7" width="100%" /></p>

<p>Next it is ‘Add post-buid action’:</p>

<p><img src="/blog/assets/img/secure-code-ci/depcheckgui8.png" alt="depcheckgui8" /></p>

<p>‘Advanced’</p>

<ul>
  <li>Dependency Check results: <code class="highlighter-rouge">depcheck/report/dependency-check-report.xml</code></li>
  <li>Status Thresholds, e.g.:</li>
  <li>All priorities Warning at: <code class="highlighter-rouge">5</code>, Failure at: <code class="highlighter-rouge">10</code></li>
  <li>Priority high: Warning at: <code class="highlighter-rouge">2</code>, Failure at: <code class="highlighter-rouge">10</code></li>
</ul>

<p><img src="/blog/assets/img/secure-code-ci/depcheckgui9.png" alt="depcheckgui9" width="100%" /></p>

<p>After that we go to ‘Save’.</p>

<p>We initiate the build process by using ‘Build now’.</p>

<p><img src="/blog/assets/img/secure-code-ci/depcheckgui10.png" alt="depcheckgui10" width="100%" /></p>

<p>The result is yellow if we populated <code class="highlighter-rouge">pom.xml</code> with the dependency<code class="highlighter-rouge"> commons-fileupload</code> - otherwise it is blue.</p>

<p>Likewise, if the commons-fileupload is the old vulnerable one, the console output will show <code class="highlighter-rouge">unstable</code>:</p>

<p><img src="/blog/assets/img/secure-code-ci/depcheckgui11.png" alt="depcheckgui11" width="100%" /></p>

<h2 id="suppressing-findings">Suppressing Findings</h2>

<p>Sometimes certain findings have to be turned off. This can have different reasons:</p>

<ol>
  <li>It is a false positive</li>
  <li>You can not change the library for some reason</li>
</ol>

<p>The so-called <strong>Suppression File</strong> serves this purpose.</p>

<p>A suppression file is an XML file with the following structure:</p>

<p><img src="/blog/assets/img/secure-code-ci/structuresuppressionfile.png" alt="structuresuppressionfile" width="100%" /></p>

<p>You can list in the suppress sections the things which should not be considered.</p>

<p>On the one hand, it can be specified which dependencies should be ignored, for example on specific jar files.
On the other hand, it defines which vulnerability should be excluded.</p>

<p>Example:</p>

<pre><code class="xml">&#x3C;suppress&#x3E;
        &#x3C;notes&#x3E;&#x3C;![CDATA[
        This suppresses cpe:/a:csv:csv:1.0 for some.jar in the &#x22;c:\path\to&#x22; directory.
        ]]&#x3E;&#x3C;/notes&#x3E;
        &#x3C;filePath&#x3E;c:\path\to\some.jar&#x3C;/filePath&#x3E;
        &#x3C;cpe&#x3E;cpe:/a:csv:csv:1.0&#x3C;/cpe&#x3E;
&#x3C;/suppress&#x3E;
</code></pre>

<p>suppresses the finding <code class="highlighter-rouge">cpe:/a:csv:csv:1.0</code> in the dependency<code class="highlighter-rouge"> c:\path\to\some.jar</code>.</p>

<h3 id="creating-suppressive-sections">Creating suppressive sections</h3>

<p>After an HTML dependency check report has been generated, you can directly generate the associated suppress section from a finding in the report:</p>

<p><img src="/blog/assets/img/secure-code-ci/depchecksuppressfromhtmlrep1.png" alt="depchecksuppressfromhtmlrep1" width="100%" /></p>

<p>Click on the Suppress button to get the snippet directly:</p>

<p><img src="/blog/assets/img/secure-code-ci/depchecksuppressfromhtmlrep2.png" alt="depchecksuppressfromhtmlrep2" width="100%" /></p>

<p>This can now be copied into the XML.</p>

<h3 id="suppression-file-in-pipeline-projects">Suppression file in pipeline projects</h3>

<p>As mentioned above, we can define the suppression file using a parameter called ‘suppressionFile’.</p>

<p>An excerpt from a Jenkinsfile might look like this:</p>

<pre><code class="bash">pipeline {
    agent any
    ...
    stages {
    ...
        stage (&#x27;Dependency Check&#x27;) {
            steps {
                ...
                dependencyCheckAnalyzer scanpath: &#x27;old_depproject&#x27;, \
                  outdir: &#x27;depcheck/report&#x27;, \
                  ...
                  suppressionFile: &#x27;suppression.xml&#x27;, \
                  zipExtensions: &#x27;&#x27;

               dependencyCheckPublisher pattern: &#x27;depcheck/report/dependency-check-report.xml&#x27;, \
                  unstableTotalAll: &#x27;0&#x27;, \
                  usePreviousBuildAsReference: false
            }
        }
    }
}
</code></pre>

<h3 id="suppression-file-in-the-gui">Suppression file in the GUI</h3>

<p>If you use the standard GUI, the suppression file can be found under ‘Build’ ‘Invoke Dependency-Check analysis’ ‘Suppression File’:</p>

<p><img src="/blog/assets/img/secure-code-ci/depchecksuppressionfilegui.png" alt="depchecksuppressionfilegui" width="100%" /></p>

<h1 id="sonarqube">Sonarqube</h1>

<p>In addition to the integration of Dependency Check in the continuous integration system Jenkins, the analysis tool can also be enabled in other connected systems.</p>

<p>One example is the continuous inspection tool <a href="https://www.sonarqube.org/"><strong>Sonarqube</strong></a>, which allows developers to check the checked-in code for specific metrics, such as test coverage.</p>

<p>This chapter describes how to augment Sonarqube with OWASP Dependency Check.</p>

<p>Again, we will work with a sample docker so that the steps can be tested before being introduced to your own project.</p>

<p>To start Sonarqube via Docker we enter the following command in the root directory:</p>

<pre><code class="bash">docker run -d --name sonarqube -p 127.0.0.1:9001:9000 -p 127.0.0.1:9092:9092 -v `pwd`/mnt/coninsserver/sonarqube_home/data:/opt/sonarqube/data -v `pwd`/mnt/coninsserver/sonarqube_home/extensions:/opt/sonarqube/extensions sonarqube:7.1
</code></pre>

<p>After a certain amount of time and if the port is not reserved, the browser will show at <code class="highlighter-rouge">http: //127.0.0.1:9001/</code>:</p>

<p><img src="/blog/assets/img/secure-code-ci/sonarqube0.png" alt="sonarqube0" width="100%" /></p>

<p>and finally:</p>

<p><img src="/blog/assets/img/secure-code-ci/sonarqube0b.png" alt="sonarqube0b" width="100%" /></p>

<h2 id="installing-sonarqube">Installing Sonarqube</h2>

<p>Starting from [the GitHub Page of the Dependency Check Sonar Plugin] (https://github.com/stevespringett/dependency-check-sonar-plugin) we first clone the plugin and build it locally:</p>

<pre><code class="bash">git clone https://github.com/stevespringett/dependency-check-sonar-plugin.git
cd dependency-check-sonar-plugin
mvn clean package
</code></pre>

<p>The output of Maven shows us where it was created:</p>

<p><img src="/blog/assets/img/secure-code-ci/sonarqubeinstalldepcheckplugin1.png" alt="sonarqubeinstalldepcheckplugin1" width="100%" /></p>

<p>Now we copy the created jar into the docker container in the subdirectory <code class="highlighter-rouge">/extensions/plugins</code> in the Sonarqube home folder.
The home folder can be found in the environment variable <code class="highlighter-rouge">SONARQUBE_HOME</code>:</p>

<pre><code class="bash">docker exec &#x3C;containerid_sonarqube&#x3E; env
</code></pre>

<pre><code class="bash">...
LANG=C.UTF-8
JAVA_HOME=/docker-java-home
JAVA_VERSION=8u171
JAVA_DEBIAN_VERSION=8u171-b11-1~deb9u1
CA_CERTIFICATES_JAVA_VERSION=20170531+nmu1
SONAR_VERSION=7.1
SONARQUBE_HOME=/opt/sonarqube
SONARQUBE_JDBC_USERNAME=sonar
SONARQUBE_JDBC_PASSWORD=sonar
SONARQUBE_JDBC_URL=
...
</code></pre>

<pre><code class="bash">docker cp &#x3C;path to created Jar&#x3E; &#x3C;containerid_sonarqube&#x3E;:/opt/sonarqube/extensions/plugins/
</code></pre>

<p>eg if we have a container ID xyz:</p>

<pre><code class="bash">docker cp sonar-dependency-check-plugin/target/sonar-dependency-check-plugin-1.1.0-SNAPSHOT.jar xyz:/opt/sonarqube/extensions/plugins/
</code></pre>

<p>To equip Sonarqube with the new plugin we need to reboot the system.</p>

<p>For this we click on ‘Login’ in the top right corner:</p>

<p><img src="/blog/assets/img/secure-code-ci/installsonarqubedepcheckplugin2.png" alt="installsonarqubedepcheckplugin2" width="100%" /></p>

<p>The standard credentials are:</p>

<p>‘admin’ ‘admin’</p>

<p><img src="/blog/assets/img/secure-code-ci/installsonarqubedepcheckplugin3.png" alt="installsonarqubedepcheckplugin3" width="100%" /></p>

<p>First, we are asked to create a token.</p>

<p>As a name we choose <code class="highlighter-rouge">project</code> for our example project and click on ‘Generate’:</p>

<p><img src="/blog/assets/img/secure-code-ci/sonarqube0d.png" alt="sonarqube0d" /></p>

<p>Next on ‘Continue’:</p>

<p><img src="/blog/assets/img/secure-code-ci/sonarqube0e.png" alt="sonarqube0e" width="100%" /></p>

<p>As programming language we choose ‘Java’ and as build technology ‘Maven’. 
We copy the command line command via the ‘Copy’ button and note it for later.</p>

<p><img src="/blog/assets/img/secure-code-ci/sonarqube0f.png" alt="sonarqube0f" width="100%" /></p>

<p>Then we finish the tutorial at the bottom right on ‘Finish this tutorial’,</p>

<p>and go to ‘Administration’:</p>

<p><img src="/blog/assets/img/secure-code-ci/sonarqubeclicktoadministration.png" alt="sonarqubeclicktoadministration" width="100%" /></p>

<p>Select ‘System’</p>

<p><img src="/blog/assets/img/secure-code-ci/sonarqube0c2.png" alt="sonarqube0c2" /></p>

<p>and ‘Restart server’</p>

<p><img src="/blog/assets/img/secure-code-ci/sonarqube0c3.png" alt="sonarqube0c3" /></p>

<p>‘Restart’</p>

<p><img src="/blog/assets/img/secure-code-ci/sonarqube0c4.png" alt="sonarqube0c4" />
<img src="/blog/assets/img/secure-code-ci/sonarqube0c5.png" alt="sonarqube0c5" /></p>

<p>After a short time the following page should be displayed:</p>

<p><img src="/blog/assets/img/secure-code-ci/sonarqube0c6.png" alt="sonarqube0c6" width="100%" /></p>

<p>If we now click on ‘Configuration’ ‘General Settings’ ‘Dependency Check’ should be displayed:</p>

<p><img src="/blog/assets/img/secure-code-ci/sonarqube0c7.png" alt="sonarqube0c7" />
<img src="/blog/assets/img/secure-code-ci/sonarqube0c8.png" alt="sonarqube0c8" width="100%" /></p>

<p>At this point, we have the plugin installed and have a token for our sample project.</p>

<h2 id="checking-the-code">Checking the code</h2>

<p>Under ‘Administration’ ‘Configuration’ we set the following paths:</p>

<ul>
  <li>Dependency-Check HTML report path : <code class="highlighter-rouge">reports/dependency-check-report.html</code></li>
  <li>Dependency-Check report path: <code class="highlighter-rouge">reports/dependency-check-report.xml</code></li>
</ul>

<p><img src="/blog/assets/img/secure-code-ci/sonarqubeclicktoadministration.png" alt="sonarqubeclicktoadministration" width="100%" />
<img src="/blog/assets/img/secure-code-ci/sonarqubecodecheck1.png" alt="sonarqubecodecheck1" width="100%" /></p>

<p>Now we go into our local project.
The project should have an vulnerable dependency named <code class="highlighter-rouge">commons-fileupload</code> in the Maven configuration file<code class="highlighter-rouge"> pom.xml</code> <a href="#">as described earlier</a>.
To generate the report for Sonarqube we enter the following in the root directory on the command line:</p>

<pre><code class="bash">cd localproject/old_depproject
mvn clean dependency:copy-dependencies
./aggregatefordepcheck.sh
[[ -d reports ]] ||mkdir reports
dependency-check --project &#x22;Example Project&#x22; -s ./alllibs -l dependency.log -f ALL -o reports
mvn sonar:sonar -Dsonar.host.url=http://127.0.0.1:9001 \
  -Dsonar.login=&#x22;&#x3C;token&#x3E;&#x22; \
  -Dsonar.dependencyCheck.reportPath=&#x22;reports/dependency-check-report.xml&#x22; \
  -Dsonar.dependencyCheck.htmlReportPath=&#x22;reports/dependency-check-report.html&#x22;
  </code></pre>

<p>Now when we go to ‘Projects’ we see the following:</p>

<p><img src="/blog/assets/img/secure-code-ci/sonarqubecodecheck2.png" alt="sonarqubecodecheck2" width="100%" /></p>

<p>And if we go to ‘old_depproject’ we get an exact breakdown:</p>

<p><img src="/blog/assets/img/secure-code-ci/sonarqubecodecheck2b.png" alt="sonarqubecodecheck2" width="100%" />
<img src="/blog/assets/img/secure-code-ci/sonarqubecodecheck3.png" alt="sonarqubecodecheck3" width="100%" />
<img src="/blog/assets/img/secure-code-ci/sonarqubecodecheck4.png" alt="sonarqubecodecheck4" width="100%" /></p>

<h1 id="summary">Summary</h1>

<p>We now have an infrastructure in which we can check dependencies in our projects on both Jenkins and Sonarqube. If new security gaps occur, these are recognized by the systems and can be reported.
In the next <a href="/blog/securecode/dast/de">blog post</a> we discuss how we can run active vulnerability scans on our project via Jenkins in addition to the dependency analysis in our projects, and so are be able to find further gaps.</p>

            </div>
        </div>
    </div>
</article>

<hr>

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                <ul class="list-inline text-center">
                    <li class="list-inline-item">
                        <a href="https://secf00tprint.github.io/blog/feed.xml">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                  </span>
                        </a>
                    </li>
                    <li class="list-inline-item">
                        <a href="https://github.com/secf00tprint">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                        </a>
                    </li>
                    <li class="list-inline-item">
                        <a href="https://www.xing.com/profile/Matthias_Altmann9">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-xing fa-stack-1x fa-inverse"></i>
                  </span>
                        </a>
                    </li>
                </ul>
                <p class="copyright text-muted">&copy;2018 <a href="/blog/legal/legalstuff.html">Legal Stuff</a></p>
            </div>
        </div>
    </div>
</footer>

<!-- Bootstrap core JavaScript -->
<script src="/blog/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Custom scripts for this template -->
<script src="/blog/js/clean-blog.min.js"></script>

</body>

</html>
